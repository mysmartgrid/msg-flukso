/** License: https://www.mysmartgrid.de/sites/all/modules/logger/js/dygraph/dygraph-canvas.js */
DygraphLayout=function(a,b){this.dygraph_=a;this.options={};Dygraph.update(this.options,b?b:{});this.datasets=[];this.annotations=[]};DygraphLayout.prototype.attr_=function(a){return this.dygraph_.attr_(a)};DygraphLayout.prototype.addDataset=function(a,b){this.datasets[a]=b};
DygraphLayout.prototype.setAnnotations=function(a){this.annotations=[];for(var b=this.attr_("xValueParser"),c=0;c<a.length;c++){var f={};if(!a[c].xval&&!a[c].x){this.dygraph_.error("Annotations must have an 'x' property");break}if(a[c].icon&&(!a[c].hasOwnProperty("width")||!a[c].hasOwnProperty("height"))){this.dygraph_.error("Must set width and height when setting annotation.icon property");break}Dygraph.update(f,a[c]);f.xval||(f.xval=b(f.x));this.annotations.push(f)}};
DygraphLayout.prototype.evaluate=function(){this._evaluateLimits();this._evaluateLineCharts();this._evaluateLineTicks();this._evaluateAnnotations()};
DygraphLayout.prototype._evaluateLimits=function(){this.minxval=this.maxxval=null;if(this.options.dateWindow)this.minxval=this.options.dateWindow[0],this.maxxval=this.options.dateWindow[1];else for(var a in this.datasets)if(this.datasets.hasOwnProperty(a)){var b=this.datasets[a];if(1<b.length){var c=b[0][0];if(!this.minxval||c<this.minxval)this.minxval=c;b=b[b.length-1][0];if(!this.maxxval||b>this.maxxval)this.maxxval=b}}this.xrange=this.maxxval-this.minxval;this.xscale=0!=this.xrange?1/this.xrange:
1;for(a=0;a<this.options.yAxes.length;a++)b=this.options.yAxes[a],b.minyval=b.computedValueRange[0],b.maxyval=b.computedValueRange[1],b.yrange=b.maxyval-b.minyval,b.yscale=0!=b.yrange?1/b.yrange:1};
DygraphLayout.prototype._evaluateLineCharts=function(){this.points=[];for(var a in this.datasets)if(this.datasets.hasOwnProperty(a))for(var b=this.datasets[a],c=this.options.yAxes[this.options.seriesToAxisMap[a]],f=0;f<b.length;f++){var d=b[f],d={x:(parseFloat(d[0])-this.minxval)*this.xscale,y:1-(parseFloat(d[1])-c.minyval)*c.yscale,xval:parseFloat(d[0]),yval:parseFloat(d[1]),name:a};this.points.push(d)}};
DygraphLayout.prototype._evaluateLineTicks=function(){this.xticks=[];for(var a=0;a<this.options.xTicks.length;a++){var b=this.options.xTicks[a],c=b.label,b=this.xscale*(b.v-this.minxval);0<=b&&1>=b&&this.xticks.push([b,c])}this.yticks=[];for(a=0;a<this.options.yAxes.length;a++)for(var f=this.options.yAxes[a],d=0;d<f.ticks.length;d++)b=f.ticks[d],c=b.label,b=1-f.yscale*(b.v-f.minyval),0<=b&&1>=b&&this.yticks.push([a,b,c])};
DygraphLayout.prototype.evaluateWithError=function(){this.evaluate();if(this.options.errorBars){var a=0,b;for(b in this.datasets)if(this.datasets.hasOwnProperty(b))for(var c=0,f=this.datasets[b],c=0;c<f.length;c++,a++){var d=f[c],e=parseFloat(d[0]),h=parseFloat(d[1]);e==this.points[a].xval&&h==this.points[a].yval&&(this.points[a].errorMinus=parseFloat(d[2]),this.points[a].errorPlus=parseFloat(d[3]))}}};
DygraphLayout.prototype._evaluateAnnotations=function(){for(var a={},b=0;b<this.annotations.length;b++){var c=this.annotations[b];a[c.xval+","+c.series]=c}this.annotated_points=[];for(b=0;b<this.points.length;b++){var c=this.points[b],f=c.xval+","+c.name;f in a&&(c.annotation=a[f],this.annotated_points.push(c))}};DygraphLayout.prototype.removeAllDatasets=function(){delete this.datasets;this.datasets=[]};DygraphLayout.prototype.updateOptions=function(a){Dygraph.update(this.options,a?a:{})};
DygraphLayout.prototype.unstackPointAtIndex=function(a){var b=this.points[a],c={},f;for(f in b)c[f]=b[f];if(!this.attr_("stackedGraph"))return c;for(f=a+1;f<this.points.length;f++)if(this.points[f].xval==b.xval){c.yval-=this.points[f].yval;break}return c};
DygraphCanvasRenderer=function(a,b,c,f){this.dygraph_=a;this.options={strokeWidth:0.5,drawXAxis:!0,drawYAxis:!0,axisLineColor:"black",axisLineWidth:0.5,axisTickSize:3,axisLabelColor:"black",axisLabelFont:"Arial",axisLabelFontSize:9,axisLabelWidth:50,drawYGrid:!0,drawXGrid:!0,gridLineColor:"rgb(128,128,128)",fillAlpha:0.15,underlayCallback:null};Dygraph.update(this.options,f);this.layout=c;this.element=b;this.container=this.element.parentNode;this.height=this.element.height;this.width=this.element.width;
if(!this.isIE&&!DygraphCanvasRenderer.isSupported(this.element))throw"Canvas is not supported.";this.xlabels=[];this.ylabels=[];this.annotations=[];this.area={x:this.options.yAxisLabelWidth+2*this.options.axisTickSize,y:0};this.area.w=this.width-this.area.x-this.options.rightGap;this.area.h=this.height-this.options.axisLabelFontSize-2*this.options.axisTickSize;2==this.dygraph_.numAxes()?this.area.w-=this.options.yAxisLabelWidth+2*this.options.axisTickSize:2<this.dygraph_.numAxes()&&this.dygraph_.error("Only two y-axes are supported at this time. (Trying to use "+
this.dygraph_.numAxes()+")");this.container.style.position="relative";this.container.style.width=this.width+"px";a=this.dygraph_.canvas_.getContext("2d");a.beginPath();a.rect(this.area.x,this.area.y,this.area.w,this.area.h);a.clip();a=this.dygraph_.hidden_.getContext("2d");a.beginPath();a.rect(this.area.x,this.area.y,this.area.w,this.area.h);a.clip()};DygraphCanvasRenderer.prototype.attr_=function(a){return this.dygraph_.attr_(a)};
DygraphCanvasRenderer.prototype.clear=function(){if(this.isIE)try{this.clearDelay&&(this.clearDelay.cancel(),this.clearDelay=null);var a=this.element.getContext("2d")}catch(b){this.clearDelay=MochiKit.Async.wait(this.IEDelay);this.clearDelay.addCallback(bind(this.clear,this));return}a=this.element.getContext("2d");a.clearRect(0,0,this.width,this.height);for(a=0;a<this.xlabels.length;a++){var c=this.xlabels[a];c.parentNode&&c.parentNode.removeChild(c)}for(a=0;a<this.ylabels.length;a++)c=this.ylabels[a],
c.parentNode&&c.parentNode.removeChild(c);for(a=0;a<this.annotations.length;a++)c=this.annotations[a],c.parentNode&&c.parentNode.removeChild(c);this.xlabels=[];this.ylabels=[];this.annotations=[]};DygraphCanvasRenderer.isSupported=function(a){var b=null;try{b="undefined"==typeof a||null==a?document.createElement("canvas"):a,b.getContext("2d")}catch(c){if(a=navigator.appVersion.match(/MSIE (\d\.\d)/),b=-1!=navigator.userAgent.toLowerCase().indexOf("opera"),!a||6>a[1]||b)return!1}return!0};
DygraphCanvasRenderer.prototype.render=function(){var a=this.element.getContext("2d");this.options.underlayCallback&&this.options.underlayCallback(a,this.area,this.dygraph_,this.dygraph_);if(this.options.drawYGrid){var b=this.layout.yticks;a.save();a.strokeStyle=this.options.gridLineColor;a.lineWidth=this.options.axisLineWidth;for(var c=0;c<b.length;c++)if(0==b[c][0]){var f=Math.round(this.area.x)+0.5,d=Math.round(this.area.y+b[c][1]*this.area.h)-0.5;a.beginPath();a.moveTo(f,d);a.lineTo(f+this.area.w,
d);a.closePath();a.stroke()}}if(this.options.drawXGrid){b=this.layout.xticks;a.save();a.strokeStyle=this.options.gridLineColor;a.lineWidth=this.options.axisLineWidth;for(c=0;c<b.length;c++)f=Math.round(this.area.x+b[c][0]*this.area.w)+0.5,d=Math.round(this.area.y+this.area.h)-0.5,a.beginPath(),a.moveTo(f,d),a.lineTo(f,this.area.y),a.closePath(),a.stroke()}this._renderLineChart();this._renderAxis();this._renderAnnotations()};
DygraphCanvasRenderer.prototype._renderAxis=function(){function a(a){return Math.round(a)+0.5}function b(a){return Math.round(a)-0.5}if(this.options.drawXAxis||this.options.drawYAxis){var c=this.element.getContext("2d"),f={position:"absolute",fontSize:this.options.axisLabelFontSize+"px",zIndex:10,color:this.options.axisLabelColor,width:this.options.axisLabelWidth+"px",overflow:"hidden"},d=function(a){var b=document.createElement("div"),c;for(c in f)f.hasOwnProperty(c)&&(b.style[c]=f[c]);b.appendChild(document.createTextNode(a));
return b};c.save();c.strokeStyle=this.options.axisLineColor;c.lineWidth=this.options.axisLineWidth;if(this.options.drawYAxis){if(this.layout.yticks&&0<this.layout.yticks.length){for(var e=0;e<this.layout.yticks.length;e++){var h=this.layout.yticks[e];if("function"==typeof h)return;var g=this.area.x,j=1;1==h[0]&&(g=this.area.x+this.area.w,j=-1);var l=this.area.y+h[1]*this.area.h;c.beginPath();c.moveTo(a(g),b(l));c.lineTo(a(g-j*this.options.axisTickSize),b(l));c.closePath();c.stroke();j=d(h[2]);g=l-
this.options.axisLabelFontSize/2;0>g&&(g=0);g+this.options.axisLabelFontSize+3>this.height?j.style.bottom="0px":j.style.top=g+"px";0==h[0]?(j.style.left="0px",j.style.textAlign="right"):1==h[0]&&(j.style.left=this.area.x+this.area.w+this.options.axisTickSize+"px",j.style.textAlign="left");j.style.width=this.options.yAxisLabelWidth+"px";this.container.appendChild(j);this.ylabels.push(j)}e=this.ylabels[0];h=this.options.axisLabelFontSize;parseInt(e.style.top)+h>this.height-h&&(e.style.top=parseInt(e.style.top)-
h/2+"px")}c.beginPath();c.moveTo(a(this.area.x),b(this.area.y));c.lineTo(a(this.area.x),b(this.area.y+this.area.h));c.closePath();c.stroke();2==this.dygraph_.numAxes()&&(c.beginPath(),c.moveTo(b(this.area.x+this.area.w),b(this.area.y)),c.lineTo(b(this.area.x+this.area.w),b(this.area.y+this.area.h)),c.closePath(),c.stroke())}if(this.options.drawXAxis){if(this.layout.xticks)for(e=0;e<this.layout.xticks.length;e++){h=this.layout.xticks[e];if("function"==typeof dataset)return;g=this.area.x+h[0]*this.area.w;
l=this.area.y+this.area.h;c.beginPath();c.moveTo(a(g),b(l));c.lineTo(a(g),b(l+this.options.axisTickSize));c.closePath();c.stroke();j=d(h[1]);j.style.textAlign="center";j.style.bottom="0px";h=g-this.options.axisLabelWidth/2;h+this.options.axisLabelWidth>this.width&&(h=this.width-this.options.xAxisLabelWidth,j.style.textAlign="right");0>h&&(h=0,j.style.textAlign="left");j.style.left=h+"px";j.style.width=this.options.xAxisLabelWidth+"px";this.container.appendChild(j);this.xlabels.push(j)}c.beginPath();
c.moveTo(a(this.area.x),b(this.area.y+this.area.h));c.lineTo(a(this.area.x+this.area.w),b(this.area.y+this.area.h));c.closePath();c.stroke()}c.restore()}};
DygraphCanvasRenderer.prototype._renderAnnotations=function(){for(var a={position:"absolute",fontSize:this.options.axisLabelFontSize+"px",zIndex:10,overflow:"hidden"},b=function(a,b,c,d){return function(e){var f=c.annotation;if(f.hasOwnProperty(a))f[a](f,c,d.dygraph_,e);else d.dygraph_.attr_(b)&&d.dygraph_.attr_(b)(f,c,d.dygraph_,e)}},c=this.layout.annotated_points,f=0;f<c.length;f++){var d=c[f];if(!(d.canvasx<this.area.x||d.canvasx>this.area.x+this.area.w)){var e=d.annotation,h=6;e.hasOwnProperty("tickHeight")&&
(h=e.tickHeight);var g=document.createElement("div"),j;for(j in a)a.hasOwnProperty(j)&&(g.style[j]=a[j]);e.hasOwnProperty("icon")||(g.className="dygraphDefaultAnnotation");e.hasOwnProperty("cssClass")&&(g.className+=" "+e.cssClass);var l=e.hasOwnProperty("width")?e.width:16,k=e.hasOwnProperty("height")?e.height:16;if(e.hasOwnProperty("icon")){var m=document.createElement("img");m.src=e.icon;m.width=l;m.height=k;g.appendChild(m)}else d.annotation.hasOwnProperty("shortText")&&g.appendChild(document.createTextNode(d.annotation.shortText));
g.style.left=d.canvasx-l/2+"px";g.style.top=e.attachAtBottom?this.area.h-k-h+"px":d.canvasy-k-h+"px";g.style.width=l+"px";g.style.height=k+"px";g.title=d.annotation.text;g.style.color=this.colors[d.name];g.style.borderColor=this.colors[d.name];e.div=g;Dygraph.addEvent(g,"click",b("clickHandler","annotationClickHandler",d,this));Dygraph.addEvent(g,"mouseover",b("mouseOverHandler","annotationMouseOverHandler",d,this));Dygraph.addEvent(g,"mouseout",b("mouseOutHandler","annotationMouseOutHandler",d,this));
Dygraph.addEvent(g,"dblclick",b("dblClickHandler","annotationDblClickHandler",d,this));this.container.appendChild(g);this.annotations.push(g);g=this.element.getContext("2d");g.strokeStyle=this.colors[d.name];g.beginPath();e.attachAtBottom?(g.moveTo(d.canvasx,this.area.h),g.lineTo(d.canvasx,this.area.h-2-h)):(g.moveTo(d.canvasx,d.canvasy),g.lineTo(d.canvasx,d.canvasy-2-h));g.closePath();g.stroke()}}};
DygraphCanvasRenderer.prototype._renderLineChart=function(){var a=this.element.getContext("2d"),b=this.options.colorScheme.length,c=this.options.colorScheme,f=this.options.fillAlpha,d=this.layout.options.errorBars,e=this.attr_("fillGraph"),h=this.layout.options.stackedGraph,g=this.layout.options.stepPlot,j=[],l;for(l in this.layout.datasets)this.layout.datasets.hasOwnProperty(l)&&j.push(l);l=j.length;this.colors={};for(var k=0;k<l;k++)this.colors[j[k]]=c[k%b];for(k=0;k<this.layout.points.length;k++)b=
this.layout.points[k],b.canvasx=this.area.w*b.x+this.area.x,b.canvasy=this.area.h*b.y+this.area.y;if(d){e&&this.dygraph_.warn("Can't use fillGraph option with error bars");for(k=0;k<l;k++){d=j[k];b=this.layout.options.yAxes[this.layout.options.seriesToAxisMap[d]];c=this.colors[d];a.save();var h=e=NaN,m=[-1,-1],q=b.yscale,b=new RGBColor(c),b="rgba("+b.r+","+b.g+","+b.b+","+f+")";a.fillStyle=b;a.beginPath();for(var n=0;n<this.layout.points.length;n++)b=this.layout.points[n],b.name==d&&(!b.y||isNaN(b.y)?
e=NaN:(g?(c=[h-b.errorPlus*q,h+b.errorMinus*q],h=b.y):c=[b.y-b.errorPlus*q,b.y+b.errorMinus*q],c[0]=this.area.h*c[0]+this.area.y,c[1]=this.area.h*c[1]+this.area.y,isNaN(e)||(g?a.moveTo(e,c[0]):a.moveTo(e,m[0]),a.lineTo(b.canvasx,c[0]),a.lineTo(b.canvasx,c[1]),g?a.lineTo(e,c[1]):a.lineTo(e,m[1]),a.closePath()),m=c,e=b.canvasx));a.fill()}}else if(e){q=[];for(k=l-1;0<=k;k--){var d=j[k],c=this.colors[d],b=this.layout.options.yAxes[this.layout.options.seriesToAxisMap[d]],p=1+b.minyval*b.yscale;0>p?p=0:
1<p&&(p=1);p=this.area.h*p+this.area.y;a.save();e=NaN;m=[-1,-1];b=new RGBColor(c);b="rgba("+b.r+","+b.g+","+b.b+","+f+")";a.fillStyle=b;a.beginPath();for(n=0;n<this.layout.points.length;n++)b=this.layout.points[n],b.name==d&&(!b.y||isNaN(b.y)?e=NaN:(h?(lastY=q[b.canvasx],void 0===lastY&&(lastY=p),q[b.canvasx]=b.canvasy,c=[b.canvasy,lastY]):c=[b.canvasy,p],isNaN(e)||(a.moveTo(e,m[0]),g?a.lineTo(b.canvasx,m[0]):a.lineTo(b.canvasx,c[0]),a.lineTo(b.canvasx,c[1]),a.lineTo(e,m[1]),a.closePath()),m=c,e=
b.canvasx));a.fill()}}for(k=0;k<l;k++){d=j[k];c=this.colors[d];f=this.dygraph_.attr_("strokeWidth",d);a.save();m=this.dygraph_.attr_("pointSize",d);h=e=null;q=this.dygraph_.attr_("drawPoints",d);p=this.layout.points;for(n=0;n<p.length;n++)if(b=p[n],b.name==d)if(!b.canvasy||isNaN(b.canvasy))g&&null!=e&&(a.beginPath(),a.strokeStyle=c,a.lineWidth=this.options.strokeWidth,a.moveTo(e,h),a.lineTo(b.canvasx,h),a.stroke()),e=h=null;else{var r=!e&&(n==p.length-1||!(p[n+1].canvasy&&!isNaN(p[n+1].canvasy)));
e?f&&(a.beginPath(),a.strokeStyle=c,a.lineWidth=f,a.moveTo(e,h),g&&a.lineTo(b.canvasx,h),e=b.canvasx,h=b.canvasy,a.lineTo(e,h),a.stroke()):(e=b.canvasx,h=b.canvasy);if(q||r)a.beginPath(),a.fillStyle=c,a.arc(b.canvasx,b.canvasy,m,0,2*Math.PI,!1),a.fill()}}a.restore()};
