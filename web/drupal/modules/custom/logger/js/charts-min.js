var chartData=null,lineChart=null,sliderCharti=null,barChart=null;function formatDate(b){return""+(10>b.getDate()?"0":"")+b.getDate()+"-"+(9>b.getMonth()?"0":"")+(b.getMonth()+1)+"-"+b.getFullYear()}function formatTime(b){return""+(10>b.getHours()?"0":"")+b.getHours()+":"+(10>b.getMinutes()?"0":"")+b.getMinutes()}function parseDate(b,d){var c=b.split("-"),e=d.split(":");return new Date(c[2],c[1]-1,c[0],e[0],e[1],0,0)}
function formatCVSTimeStamp(b){return""+b.getFullYear()+"-"+(9>b.getMonth()?"0":"")+(b.getMonth()+1)+"-"+(10>b.getDate()?"0":"")+b.getDate()+" "+(10>b.getHours()?"0":"")+b.getHours()+":"+(10>b.getMinutes()?"0":"")+b.getMinutes()}
function getStyleBySelector(b){var d=document.styleSheets,c,e,f,g,h,k=void 0==d[0].cssRules;for(g=d.length-1;0<=g;g--){c=k?d[g].rules:d[g].cssRules;f=findStyle(c,b);if(null!=f)return f;c=k?d[g].imports:c;for(h=0;h<c.length;h++){if(void 0!=c[h].rules)e=c[h].rules;else if(void 0!=c[h].styleSheet)e=c[h].styleSheet.cssRules;else if(void 0!=document.cookie&&0<=document.cookie.indexOf("mysmartgrid_cookiecontrol"))window.location="/webbrowser";else return null;f=findStyle(e,b);if(null!=f)return f}}return null}
function findStyle(b,d){var c,e;for(c=0;c<b.length;c++)if(e=b[c],e.selectorText&&e.selectorText.toLowerCase()==d)return e.style;return null}function percentToPx(b,d){return-1<b.indexOf("%")?parseInt(b.replace("%",""))*d/100:b.replace("px","")}function isMobile(){return 600>document.body.clientWidth}function hideZero(b){return 0==b?"":b.toFixed(2)}
function updateLineChartForm(b){var d=document.getElementById("logger-linechart-form");if(d){var c=Math.round(b.yAxisRange(0)[0]),e=Math.round(b.yAxisRange(0)[1]);0==e&&0==c&&(e=c="");d.elements.yvalue1.value=c;d.elements.yvalue2.value=e;c=new Date(Math.round(b.xAxisRange(0)[0]));d.elements.xvalue1date.value=formatDate(c);d.elements.xvalue1time.value=formatTime(c);c=new Date(Math.round(b.xAxisRange(0)[1]));d.elements.xvalue2date.value=formatDate(c);d.elements.xvalue2time.value=formatTime(c)}refreshLineAnnotations();
updateLineLegend(b)}function submitLineChartForm(b){var d=document.getElementById("logger-linechart-form");b&&(d.elements.yvalue1.value="",d.elements.yvalue2.value="");d.submit()}function enableFilledGraph(){document.getElementById("logger-linechart-form").elements.filled_graph.checked=1}
function submitBarChartForm(b){var d=document.getElementById("logger-barchart-form"),c=findCheckBoxes(d,"selected_meters"),e=!1,f=!1;0<c.length&&(f=!0,e=isAnyOptionChecked(c));if(!f||e)c=findCheckBoxes(d,"selected_sensor_types"),f=!1,0<c.length&&(f=!0,e=isAnyOptionChecked(c));!f||e?d.submit():b.checked=!0}function isAnyOptionChecked(b){for(var d=!1,c=0;c<b.length;c++)if(b[c].checked){d=!0;break}return d}
function findCheckBoxes(b,d){for(var c=[],e=0,f=0;f<b.elements.length;f++)0==b.elements[f].name.indexOf(d,0)&&(c[e++]=b.elements[f]);return c}function removeLineSeries(b,d,c,e,f,g){b=lineChart.visibility();isLastVisibleLine(d,b)||(document.getElementById(f).rows[d+1].style.display="none",setLineVisibility(d,!1),document.getElementById("logger-linechart-form"),jQuery.get("/logger/remove/sensor/"+e+"/"+g))}
function hideLineSeries(b,d,c,e,f,g,h){b=lineChart.visibility();isLastVisibleLine(d,b)||((b=!b[d])?(g=f,f="visible"):f="hidden",document.getElementById("hide-legend-row"+d).innerHTML=g,setLineVisibility(d,b),document.getElementById("max"+d).style.visibility=f,document.getElementById("min"+d).style.visibility=f,document.getElementById("avg"+d).style.visibility=f,document.getElementById("last"+d).style.visibility=f,jQuery.get("/logger/hide/sensor/"+e+"/"+h))}
function isLastVisibleLine(b,d){for(var c=0,e=0;e<d.length;e++)c+=d[e]?1:0;return d[b]&&1==c}function setLineVisibility(b,d){lineChart.setVisibility(b,d);sliderChart&&sliderChart.setVisibility(b,d)}function updateSmoothingLevel(b,d){var c=document.getElementById(b),e=1*c.value+d,e=1>e?1:e;c.value=e;lineChart.setAnnotations([]);lineChart.updateOptions({rollPeriod:e});sliderChart&&sliderChart.updateOptions({rollPeriod:e});jQuery.get("/logger/setvariable/smoothing_level/"+e);return!0}
function updateLineChart(b,d){lineChart.updateOptions({dateWindow:[b,d]});sliderChart&&sliderChart.updateOptions({dateWindow:null});updateLineChartForm(lineChart)}function updateSliderChart(){sliderChart.updateOptions({dateWindow:sliderChart.xAxisRange()});updateLineChartForm(lineChart)}function expandLineChart(){lineChart.updateOptions({dateWindow:null});lineChart.updateOptions({valueRange:null});updateSliderChart()}
function slideLineChart(b,d){var c=lineChart.xAxisRange(0)[0],e=lineChart.xAxisRange(0)[1],c=(e-c)/2;lineChart.updateOptions({dateWindow:[d-c,d+c]});sliderChart.updateOptions({dateWindow:sliderChart.xAxisRange()});updateLineChartForm(lineChart)}function highlightLineChart(b,d,c){var e=lineChart.xAxisRange(0)[0],f=lineChart.xAxisRange(0)[1],g=c.yAxisRange(0)[0],h=c.yAxisRange(0)[1],e=c.toDomCoords(e,0)[0];c=c.toDomCoords(f,0)[0]-e;b.fillStyle="#a5d2d9";b.fillRect(e,d.y,c,h-g+100)}
function updateLineLegend(b){for(var d=b.xAxisRange(0)[0],c=b.xAxisRange(0)[1],e=b.visibility(),f=1;f<b.numColumns();f++){var g=Number.MIN_VALUE,h=Number.MAX_VALUE,k=0,p=0,m=null;if(e[f-1])for(var j=0;j<b.numRows();j++){var l=b.getValue(j,0);l>=d&&l<=c&&(m=l=(l=b.getValue(j,f))?l:0,g=l>g?l:g,h=l<h?l:h,0!=l&&(k+=l,p++))}g=g==Number.MIN_VALUE?null:g;h=h==Number.MAX_VALUE?null:h;avg=0<p?k/p:null;updateLineLegendValue("max",f,g);updateLineLegendValue("min",f,h);updateLineLegendValue("avg",f,avg);updateLineLegendValue("last",
f,m);updateLineLegendValue("sum",f,k)}}function updateLineLegendValue(b,d,c){if(b=document.getElementById(b+--d))c&&!isNaN(c-0)?(d=Math.abs(c),c=0.01<=d?c.toFixed(2):0.001<=d?c.toFixed(3):c,b.innerHTML=0==d?"":0.001>d?"0.000...":c):b.innerHTML=""}var annotationDivs={};
function addLineAnnotation(b,d){var c=d.name.substring(1)-1,e="annotation"+c+""+d.xval,f=(d.xval-d.xval%36E5)/1E3,g=new Date(d.xval),h=(g.getTime()-g.getTime()%1E3)/1E3,k=d.yval.toFixed(2),p=d.name+": "+formatDate(g)+" - "+k,m=50*(""+k).length/6,j=15,l="";if(h=getAppliances(c,h))l+=h,m+=45*(h.length/100),j=30;if(c=getWeather(c,f))l+=c,m+=75,j=30;g={series:d.name,x:formatCVSTimeStamp(g),shortText:k,text:p,width:m,height:j,cssClass:"point-annotation "+e,clickHandler:function(c,b,d){removeLineAnnotation(d,
e)}};p=lineChart.annotations();p.push(g);lineChart.setAnnotations(p);g=findAnnotationDiv(e);if(c||h)g.innerHTML='<span class="point-annotation">'+k+"</span>"+l;annotationDivs[e]=g.innerHTML;refreshLineAnnotations()}function refreshLineAnnotations(){for(id in annotationDivs){var b=findAnnotationDiv(id);b&&(b.innerHTML=annotationDivs[id])}}
function removeLineAnnotation(b,d){for(var c=[],e=b.annotations(),f=0;f<e.length;f++)0>e[f].cssClass.indexOf(d)&&c.push(e[f]);b.setAnnotations(c);refreshLineAnnotations()}function findAnnotationDiv(b){for(var d=document.getElementsByTagName("div"),c=0;c<d.length;c++){var e=d[c];if(-1!=e.className.indexOf(b))return e}return null}
function getAppliances(b,d){var c=[],e=lineChart.fileURL.substring(lineChart.fileURL.lastIndexOf("/")+1);jQuery.ajax({async:!1,url:"/logger/getappliances/"+e,success:function(b){c=b}});e="";for(a in c[b])0<parseInt(c[b][a][d])&&(e+='<img class="point-annotation" src="/sites/all/modules/logger/img/appliances/icon-'+a+'.jpg"/>');return e}
function getWeather(b,d){for(var c=lineChart.weather,e=0;e<c.length;e++)if(c[e][0]==b)for(var f=0;f<c[e][1].length;f++)if(c[e][1][f][0]==d)return'<span class="point-annotation">&nbsp;&nbsp;('+c[e][1][f][2]+'\u00b0)</span><img class="point-annotation" src="/sites/all/modules/logger/img/weather/icon-'+c[e][1][f][1]+'.jpg"/>';return null}function downloadChartData(b){null==chartData&&jQuery.ajax({url:"/"+b,async:!1,success:function(b){chartData=b}});return chartData}
function createLineChart(b,d,c,e){var f=document.getElementById(b),g=getStyleBySelector("div."+f.className);c.width=percentToPx(g.width,f.clientWidth);c.height=percentToPx(g.height);c.axisLabelFontSize=g.fontSize.replace("px","");c.yAxisLabelWidth=4*c.axisLabelFontSize;c=new Dygraph(f,downloadChartData(d),c);c.weather=e;c.fileURL=d;storeChart(b,c);return c}
function createBarChart(b,d,c,e,f,g,h,k){for(var p=0<h.length,m=c.length,j=1/((p?Math.max.apply(null,h)+1:d.length)+1),l,t=[m],n=0;n<m;n++)l=n+(p?0:Math.floor((d.length-1)/2)*j),t[n]=[l,c[n]];var r=[d.length];for(c=0;c<d.length;c++){for(var n=[m],s=h[c],q=0;q<m;q++)l=q+j*(p?s:c),n[q]=[l,d[c][q]];r[c]={data:n,stack:p?h[c]:null}}var u={colors:e,series:{bars:{show:!0,barWidth:j,lineWidth:0,fill:1,align:"center"}},xaxis:{min:-1*j,max:m-j,ticks:t},grid:{clickable:!0},yaxis:{autoscaleMargin:0.05,tickFormatter:function(b){return k?
b.toFixed(0)+"%":b.toFixed(1)}}};d={};d.id=b;d.data=r;d.options=u;d.plot=function(){var c=jQuery.plot(jQuery("#"+b),r,u);showBarDataLabels(c,h,f,j,15);showBarDataLabels(c,h,g,j,-5)};d.plot();storeChart(b,d);return d}function storeChart(b,d){"lineChart"==b?(lineChart=d,barChart=sliderChart=null):"sliderChart"==b?(sliderChart=d,chartData=barChart=null):"barChart"==b&&(barChart=d,chartData=sliderChart=lineChart=null)}
function getChart(b){return"lineChart"==b?lineChart:"sliderChart"==b?sliderChart:"barChart"==b?barChart:null}
function showBarDataLabels(b,d,c,e,f){if(0!=c.length)for(var g=b.getData(),h=0<d.length,k=b.pointOffset({x:0,y:0}),p=k.top,m=createBiArray(20,20,f),j=0;j<g.length;j++)void 0!=c[j]&&jQuery.each(g[j].data,function(f,g){var n=g[0];if(0<=n){var r=g[1];if(!(0>=r)){var s=h?d[j]:j,q=Math.round(n-e*s);k=b.pointOffset({x:n,y:r});n=p-k.top;k.top-=m[s][q];15>n&&(k.top+=n-15);h&&(m[s][q]+=n);showDataLabel(b,k,e,c[j][q])}}})}
function showDataLabel(b,d,c,e){if(null!=e){"number"==typeof e&&(e=e.toFixed(1E3>e?2:0),0==e&&(e+="..."));var f=getStyleBySelector("p.chart-label"),f=parseInt(f.fontSize.replace("px",""));0.3<c&&(f+=2);d={position:"absolute",left:d.left-25,top:d.top,display:"none"};jQuery('<div style="font-size: '+f+'px; width: 50px; height: 15px; text-align: center;">'+e+"</div>").css(d).appendTo(b.getPlaceholder()).fadeIn("slow")}}
function createBiArray(b,d,c){for(var e=Array(b),f=0;f<b;f++){e[f]=Array(d);for(var g=0;g<d;g++)e[f][g]=c}return e}function setSeriesColor(b,d,c){c="#"+c;barChart&&(barChart.options.colors[d]=c,barChart.plot());lineChart&&updateDygraphColors();jQuery.get("/logger/setvariable/series_color_"+b+"_"+d+"/"+escape(c));return!0}
function syncColorPickers(b,d){for(var c=document.getElementsByClassName("color"),e=0;e<c.length;e++)0<c[e].className.indexOf("series_color"+b)&&(c[e].style.background="#"+d,c[e].style.color="transparent",c[e].value=d);return!0}function updateDygraphColors(){for(var b=lineChart.getColors(),d=lineChart.visibility(),c=0;c<d.length;c++){var e=document.getElementById("series_color"+c);e&&(b[c]="#"+e.value)}lineChart.updateOptions({colors:b});sliderChart&&sliderChart.updateOptions({colors:b})}
function resizeCharts(){isMobile()&&(resizeLineChart("lineChart"),resizeLineChart("sliderChart"),resizeBarChart())}function resizeLineChart(b){var d=getChart(b);if(d){var c=400<document.body.clientWidth;b=document.getElementById(b);b=getStyleBySelector("div."+b.className).height.replace("px","");d.resize(c?460:295,b)}}function resizeBarChart(){barChart&&barChart.plot()}
function resizeLegend(b,d,c){if(isMobile()&&(b=document.getElementById(b))){var e=400<document.body.clientWidth?"table-cell":"none";d=d?d:3;c=c?c:b.rows[0].cells.length-1;for(var f=0;f<b.rows.length;f++)for(var g=b.rows[f].cells,h=d;h<c;h++)g[h].style.display=e}};