var chartData=null,lineChart=null,sliderCharti=null,barChart=null;function formatDate(d){return""+(10>d.getDate()?"0":"")+d.getDate()+"-"+(9>d.getMonth()?"0":"")+(d.getMonth()+1)+"-"+d.getFullYear()}function formatTime(d){return""+(10>d.getHours()?"0":"")+d.getHours()+":"+(10>d.getMinutes()?"0":"")+d.getMinutes()}function parseDate(d,c){var b=d.split("-"),e=c.split(":");return new Date(b[2],b[1]-1,b[0],e[0],e[1],0,0)} function getStyleBySelector(d){var c=document.styleSheets,b,e,f,g,h,k=void 0==c[0].cssRules;for(g=c.length-1;0<=g;g--){b=k?c[g].rules:c[g].cssRules;f=findStyle(b,d);if(null!=f)return f;b=k?c[g].imports:b;for(h=0;h<b.length;h++){if(void 0!=b[h].rules)e=b[h].rules;else if(void 0!=b[h].styleSheet)e=b[h].styleSheet.cssRules;else if(void 0!=document.cookie&&0<=document.cookie.indexOf("mysmartgrid_cookiecontrol"))window.location="/webbrowser";else return null;f=findStyle(e,d);if(null!=f)return f}}return null} function findStyle(d,c){var b,e;for(b=0;b<d.length;b++)if(e=d[b],e.selectorText&&e.selectorText.toLowerCase()==c)return e.style;return null}function percentToPx(d,c){return-1<d.indexOf("%")?parseInt(d.replace("%",""))*c/100:d.replace("px","")}function hideZero(d){return 0==d?"":d.toFixed(2)} function updateLineChartForm(d){var c=document.getElementById("logger-linechart-form");if(c){var b=Math.round(d.yAxisRange(0)[0]),e=Math.round(d.yAxisRange(0)[1]);0==e&&0==b&&(e=b="");c.elements.yvalue1.value=b;c.elements.yvalue2.value=e;b=new Date(Math.round(d.xAxisRange(0)[0]));c.elements.xvalue1date.value=formatDate(b);c.elements.xvalue1time.value=formatTime(b);b=new Date(Math.round(d.xAxisRange(0)[1]));c.elements.xvalue2date.value=formatDate(b);c.elements.xvalue2time.value=formatTime(b)}refreshLineAnnotations(); updateLineLegend(d)}function submitLineChartForm(d){var c=document.getElementById("logger-linechart-form");d&&(c.elements.yvalue1.value="",c.elements.yvalue2.value="");c.submit()}function enableFilledGraph(){document.getElementById("logger-linechart-form").elements.filled_graph.checked=1} function submitBarChartForm(d){var c=document.getElementById("logger-barchart-form"),b=findCheckBoxes(c,"selected_meters"),e=!1,f=!1;0<b.length&&(f=!0,e=isAnyOptionChecked(b));if(!f||e)b=findCheckBoxes(c,"selected_sensor_types"),f=!1,0<b.length&&(f=!0,e=isAnyOptionChecked(b));!f||e?c.submit():d.checked=!0}function isAnyOptionChecked(d){for(var c=!1,b=0;b<d.length;b++)if(d[b].checked){c=!0;break}return c} function findCheckBoxes(d,c){for(var b=[],e=0,f=0;f<d.elements.length;f++)0==d.elements[f].name.indexOf(c,0)&&(b[e++]=d.elements[f]);return b}function removeLineSeries(d,c,b,e,f,g){d=lineChart.visibility();isLastVisibleLine(c,d)||(document.getElementById(f).rows[c+1].style.display="none",setLineVisibility(c,!1),document.getElementById("logger-linechart-form"),jQuery.get("/logger/remove/sensor/"+e+"/"+g))} function hideLineSeries(d,c,b,e,f,g,h){d=lineChart.visibility();isLastVisibleLine(c,d)||((d=!d[c])?(g=f,f="visible"):f="hidden",document.getElementById("hide-legend-row"+c).innerHTML=g,setLineVisibility(c,d),document.getElementById("max"+c).style.visibility=f,document.getElementById("min"+c).style.visibility=f,document.getElementById("avg"+c).style.visibility=f,document.getElementById("last"+c).style.visibility=f,jQuery.get("/logger/hide/sensor/"+e+"/"+h))} function isLastVisibleLine(d,c){for(var b=0,e=0;e<c.length;e++)b+=c[e]?1:0;return c[d]&&1==b}function setLineVisibility(d,c){lineChart.setVisibility(d,c);sliderChart&&sliderChart.setVisibility(d,c)}function updateSmoothingLevel(d,c){var b=document.getElementById(d),e=1*b.value+c,e=1>e?1:e;b.value=e;lineChart.setAnnotations([]);lineChart.updateOptions({rollPeriod:e});sliderChart&&sliderChart.updateOptions({rollPeriod:e});jQuery.get("/logger/setvariable/smoothing_level/"+e);return!0} function updateLineChart(d,c){lineChart.updateOptions({dateWindow:[d,c]});sliderChart&&sliderChart.updateOptions({dateWindow:null});updateLineChartForm(lineChart)}function updateSliderChart(){sliderChart.updateOptions({dateWindow:sliderChart.xAxisRange()});updateLineChartForm(lineChart)}function expandLineChart(){lineChart.updateOptions({dateWindow:null});lineChart.updateOptions({valueRange:null});updateSliderChart()} function slideLineChart(d,c){var b=lineChart.xAxisRange(0)[0],e=lineChart.xAxisRange(0)[1],b=(e-b)/2;lineChart.updateOptions({dateWindow:[c-b,c+b]});sliderChart.updateOptions({dateWindow:sliderChart.xAxisRange()});updateLineChartForm(lineChart)}function highlightLineChart(d,c,b){var e=lineChart.xAxisRange(0)[0],f=lineChart.xAxisRange(0)[1],g=b.yAxisRange(0)[0],h=b.yAxisRange(0)[1],e=b.toDomCoords(e,0)[0];b=b.toDomCoords(f,0)[0]-e;d.fillStyle="#a5d2d9";d.fillRect(e,c.y,b,h-g+100)} function updateLineLegend(d){for(var c=d.xAxisRange(0)[0],b=d.xAxisRange(0)[1],e=d.visibility(),f=1;f<d.numColumns();f++){var g=Number.MIN_VALUE,h=Number.MAX_VALUE,k=0,p=0,m=null;if(e[f-1])for(var j=0;j<d.numRows();j++){var l=d.getValue(j,0);l>=c&&l<=b&&(m=l=(l=d.getValue(j,f))?l:0,g=l>g?l:g,h=l<h?l:h,0!=l&&(k+=l,p++))}g=g==Number.MIN_VALUE?null:g;h=h==Number.MAX_VALUE?null:h;avg=0<p?k/p:null;updateLineLegendValue("max",f,g);updateLineLegendValue("min",f,h);updateLineLegendValue("avg",f,avg);updateLineLegendValue("last", f,m);updateLineLegendValue("sum",f,k)}}function updateLineLegendValue(d,c,b){if(d=document.getElementById(d+--c))b&&!isNaN(b-0)?(c=Math.abs(b),b=0.01<=c?b.toFixed(2):0.001<=c?b.toFixed(3):b,d.innerHTML=0==c?"":0.001>c?"0.000...":b):d.innerHTML=""}var annotationDivs={}; function addLineAnnotation(d,c){var b=c.name.substring(1)-1,e="annotation"+b+""+c.xval,f=(c.xval-c.xval%36E5)/1E3,g=new Date(c.xval),h=(g.getTime()-g.getTime()%1E3)/1E3,k=c.yval.toFixed(2),p=c.name+": "+formatDate(g)+" - "+k,m=50*(""+k).length/6,j=15,g="",l=getAppliances(b,h);l&&(g+=l,m+=45*(l.length/100),j=30);if(b=getWeather(b,f))g+=b,m+=75,j=30;h={series:c.name,x:h,shortText:k,text:p,width:m,height:j,cssClass:"point-annotation "+e,clickHandler:function(b,d,c){removeLineAnnotation(c,e)}};f=lineChart.annotations(); f.push(h);lineChart.setAnnotations(f);h=findAnnotationDiv(e);if(b||l)h.innerHTML='<span class="point-annotation">'+k+"</span>"+g;annotationDivs[e]=h.innerHTML;refreshLineAnnotations()}function refreshLineAnnotations(){for(id in annotationDivs){var d=findAnnotationDiv(id);d&&(d.innerHTML=annotationDivs[id])}}function removeLineAnnotation(d,c){for(var b=[],e=d.annotations(),f=0;f<e.length;f++)0>e[f].cssClass.indexOf(c)&&b.push(e[f]);d.setAnnotations(b);refreshLineAnnotations()} function findAnnotationDiv(d){for(var c=document.getElementsByTagName("div"),b=0;b<c.length;b++){var e=c[b];if(-1!=e.className.indexOf(d))return e}return null}function getAppliances(d,c){var b=[],e=lineChart.fileURL.substring(lineChart.fileURL.lastIndexOf("/")+1);jQuery.ajax({async:!1,url:"/logger/getappliances/"+e,success:function(c){b=c}});e="";for(a in b[d])0<parseInt(b[d][a][c])&&(e+='<img class="point-annotation" src="/sites/all/modules/logger/img/appliances/icon-'+a+'.jpg"/>');return e} function getWeather(d,c){for(var b=lineChart.weather,e=0;e<b.length;e++)if(b[e][0]==d)for(var f=0;f<b[e][1].length;f++)if(b[e][1][f][0]==c)return'<span class="point-annotation">&nbsp;&nbsp;('+b[e][1][f][2]+'\u00b0)</span><img class="point-annotation" src="/sites/all/modules/logger/img/weather/icon-'+b[e][1][f][1]+'.jpg"/>';return null}function downloadChartData(d){null==chartData&&jQuery.ajax({url:"/"+d,async:!1,success:function(c){chartData=c}});return chartData} function createLineChart(d,c,b,e){var f=document.getElementById(d),g=getStyleBySelector("div."+f.className);b.width=percentToPx(g.width,f.clientWidth);b.height=percentToPx(g.height);b.axisLabelFontSize=g.fontSize.replace("px","");b.yAxisLabelWidth=4*b.axisLabelFontSize;b=new Dygraph(f,downloadChartData(c),b);b.weather=e;b.fileURL=c;storeChart(d,b);return b} function createBarChart(d,c,b,e,f,g,h,k){for(var p=0<h.length,m=b.length,j=1/((p?Math.max.apply(null,h)+1:c.length)+1),l,t=[m],n=0;n<m;n++)l=n+(p?0:Math.floor((c.length-1)/2)*j),t[n]=[l,b[n]];var r=[c.length];for(b=0;b<c.length;b++){for(var n=[m],s=h[b],q=0;q<m;q++)l=q+j*(p?s:b),n[q]=[l,c[b][q]];r[b]={data:n,stack:p?h[b]:null}}var u={colors:e,series:{bars:{show:!0,barWidth:j,lineWidth:0,fill:1,align:"center"}},xaxis:{min:-1*j,max:m-j,ticks:t},grid:{clickable:!0},yaxis:{autoscaleMargin:0.05,tickFormatter:function(b){return k? b.toFixed(0)+"%":b.toFixed(1)}}};c={};c.id=d;c.data=r;c.options=u;c.plot=function(){var b=jQuery.plot(jQuery("#"+d),r,u);showBarDataLabels(b,h,f,j,15);showBarDataLabels(b,h,g,j,-5)};c.plot();storeChart(d,c);return c}function storeChart(d,c){"lineChart"==d?(lineChart=c,barChart=sliderChart=null):"sliderChart"==d?(sliderChart=c,chartData=barChart=null):"barChart"==d&&(barChart=c,chartData=sliderChart=lineChart=null)} function getChart(d){return"lineChart"==d?lineChart:"sliderChart"==d?sliderChart:"barChart"==d?barChart:null} function showBarDataLabels(d,c,b,e,f){if(0!=b.length)for(var g=d.getData(),h=0<c.length,k=d.pointOffset({x:0,y:0}),p=k.top,m=createBiArray(20,20,f),j=0;j<g.length;j++)void 0!=b[j]&&jQuery.each(g[j].data,function(f,g){var n=g[0];if(0<=n){var r=g[1];if(!(0>=r)){var s=h?c[j]:j,q=Math.round(n-e*s);k=d.pointOffset({x:n,y:r});n=p-k.top;k.top-=m[s][q];15>n&&(k.top+=n-15);h&&(m[s][q]+=n);showDataLabel(d,k,e,b[j][q])}}})} function showDataLabel(d,c,b,e){if(null!=e){"number"==typeof e&&(e=e.toFixed(1E3>e?2:0),0==e&&(e+="..."));var f=getStyleBySelector("p.chart-label"),f=parseInt(f.fontSize.replace("px",""));0.3<b&&(f+=2);c={position:"absolute",left:c.left-25,top:c.top,display:"none"};jQuery('<div style="font-size: '+f+'px; width: 50px; height: 15px; text-align: center;">'+e+"</div>").css(c).appendTo(d.getPlaceholder()).fadeIn("slow")}} function createBiArray(d,c,b){for(var e=Array(d),f=0;f<d;f++){e[f]=Array(c);for(var g=0;g<c;g++)e[f][g]=b}return e}function setSeriesColor(d,c,b){b="#"+b;barChart&&(barChart.options.colors[c]=b,barChart.plot());lineChart&&updateDygraphColors();jQuery.get("/logger/setvariable/series_color_"+d+"_"+c+"/"+escape(b));return!0} function syncColorPickers(d,c){for(var b=document.getElementsByClassName("color"),e=0;e<b.length;e++)0<b[e].className.indexOf("series_color"+d)&&(b[e].style.background="#"+c,b[e].style.color="transparent",b[e].value=c);return!0}function updateDygraphColors(){for(var d=lineChart.getColors(),c=lineChart.visibility(),b=0;b<c.length;b++){var e=document.getElementById("series_color"+b);e&&(d[b]="#"+e.value)}lineChart.updateOptions({colors:d});sliderChart&&sliderChart.updateOptions({colors:d})} function resizeCharts(){isMobile()&&(resizeLineChart("lineChart"),resizeLineChart("sliderChart"),resizeBarChart())}function resizeLineChart(d){var c=getChart(d);if(c){var b=400<document.body.clientWidth;d=document.getElementById(d);d=getStyleBySelector("div."+d.className).height.replace("px","");c.resize(b?460:295,d)}}function resizeBarChart(){barChart&&barChart.plot()};
