<?php

/**
 * Support module for charting flukso measurements.
 *
 * Copyright (c) 2008-2009 jokamajo.org
 *               2010 flukso.net
 *               2010 Fraunhofer Institut ITWM (www.itwm.fraunhofer.de)
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA.
 */

//Constants
define('ROOT_PATH',  drupal_get_path('module', 'logger'));
define('GRAPH_PATH', ROOT_PATH . '/graphs');

define('MINUTE', 60);
define('HOUR',   60 * MINUTE);
define('DAY',    24 * HOUR);
define('WEEK',    7 * DAY);
define('YEAR',   52 * WEEK);

define('CHART_REFRESH', 15 * MINUTE);
define('CHART_HEIGHT', 350);
define('SLIDER_HEIGHT', 50);
define('CHART_UNIT', 'logger_chart_unit');
define('SERIES_COLOR_ID', 'logger_series_color_id');
define('SMOOTHING_LEVEL_ID', 'logger_smooting_level_id');
define('STEP_PLOT_ID', 'logger_step_plot');

function logger_init() {
  
  drupal_add_js(ROOT_PATH . '/js/jscolor/jscolor.js');
  drupal_add_js(ROOT_PATH . '/js/dashboard.js');

  //If IE
  if (strpos($_SERVER['HTTP_USER_AGENT'], 'MSIE')) {
    drupal_add_js(ROOT_PATH . '/js/dygraph/excanvas.js');
  }

  drupal_add_js(ROOT_PATH . '/js/dygraph/strftime-min.js');
  drupal_add_js(ROOT_PATH . '/js/dygraph/rgbcolor.js');
  drupal_add_js(ROOT_PATH . '/js/dygraph/dygraph-canvas.js');
  drupal_add_js(ROOT_PATH . '/js/dygraph/dygraph.js');

  jquery_ui_add(array('ui.datepicker'));
  drupal_add_css(ROOT_PATH . '/style/ui.datepicker.css');
}

function logger_perm() {
  return array('logger', 'register devices');
}

function logger_menu() {

  $items = array();

  // Dashboard operations

  $items['logger'] = array(
    'title'            => 'Your power consumption',
    'description'      => 'Show the dashboard.',
    'page callback'    => '_logger_dashboard',
    'page arguments'   => array(1, 2),
    'access callback'  => TRUE,
    'type'             => MENU_CALLBACK
  );

  $items['overview'] = array(
    'title'            => 'Overall View',
    'description'      => 'Show the project overall view.',
    'page callback'    => '_logger_overview',
    'page arguments'   => array(1, 2),
    'access callback'  => TRUE,
    'type'             => MENU_CALLBACK
  );

  $items['logger/color'] = array(
    'title'            => 'Change the series color',
    'page callback'    => '_logger_series_color',
    'page arguments'   => array(2, 3),
    'access callback'  => TRUE,
    'type'             => MENU_CALLBACK
  );


  //Devices' operations

  $items['user/%user_uid_optional/devices'] = array(
    'title'            => 'Devices',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('_logger_account_devices'),
    'access callback'  => '_logger_account_access',
    'access arguments' => array('register devices', 1),
    'type'             => MENU_LOCAL_TASK,
    'file'             => 'logger.admin.inc',
    'weight'           => 3,
  );

  $items['device/deactivate'] = array(
    'title'            => $items['user/%user_uid_optional/devices']['title'],
    'page callback'    => '_logger_device_deactivate',
    'page arguments'   => array(2),
    'access callback'  => '_logger_device_access',
    'access arguments' => array('logger', 2),
    'type'             => MENU_CALLBACK,
    'file'             => 'logger.admin.inc'
  );


  //Sensors' operations

  $items['user/%user_uid_optional/sensors'] = array(
    'title'            => 'Sensors',
    'page callback'    => '_logger_account_sensors',
    'access callback'  => '_logger_account_access',
    'access arguments' => array('logger', 1),
    'type'             => MENU_LOCAL_TASK,
    'file'             => 'logger.admin.inc',
    'weight'           => 3,
  );

  $items['sensor/edit'] = array(
    'title'            => 'Sensor Edition',
    'page callback'    => '_logger_sensor_edit',
    'page arguments'   => array(2),
    'access callback'  => '_logger_sensor_access',
    'access arguments' => array('logger', 2),
    'type'             => MENU_CALLBACK,
    'file'             => 'logger.admin.inc'
  );

  $items['sensor/deactivate'] = array(
    'title'            => $items['user/%user_uid_optional/sensors']['title'],
    'page callback'    => '_logger_sensor_deactivate',
    'page arguments'   => array(2),
    'access callback'  => '_logger_sensor_access',
    'access arguments' => array('logger', 2),
    'type'             => MENU_CALLBACK,
    'file'             => 'logger.admin.inc'
  );

  $items['sensor/activate'] = array(
    'title'            => $items['sensor/edit']['title'],
    'page callback'    => '_logger_sensor_activate',
    'page arguments'   => array(2),
    'access callback'  => '_logger_sensor_access',
    'access arguments' => array('logger', 2),
    'type'             => MENU_CALLBACK,
    'file'             => 'logger.admin.inc'
  );


  /* Other operations */

  $items['installation'] = array(
    'title'            => '',
    'description'      => 'Howto install a Fluksometer',
    'page callback'    => '_logger_installation',
    'access callback'  => TRUE,
    'type'             => MENU_CALLBACK,
  );

  $items['admin/settings/logger'] = array(
    'title'            => 'Logger settings',
    'description'      => 'Configure settings for logging metering values.',
    'page callback'    => 'drupal_get_form',
    'page arguments'   => array('_logger_admin_settings'),
    'access arguments' => array('administer site configuration'),
  );

  $items['user/%user_uid_optional/privacy'] = array(
    'title'            => 'Privacy',
    'page callback'    => '_logger_account_privacy',
    'access callback'  => '_logger_account_access',
    'access arguments' => array('logger', 1),
    'type'             => MENU_LOCAL_TASK,
    'file'             => 'logger.admin.inc',
    'weight'           => 2,
  );

  return $items;
}

function _logger_installation() {

  return
    '<div class="install">' . PHP_EOL .
    "<a class='img' href = 'http://www.flukso.net/installation'>
       <img src='http://www.flukso.net/sites/default/files/images/step1.png'
       height='120' width='150' alt='step 1'/>
     </a>" . PHP_EOL .

    "<p><b>STEP 1: CONFIGURING WIFI</b><br/>
       Power up the Fluksometer. Connect your computer to the Fluksometer's
       ethernet port. Surf to
       <a href = 'http://192.168.255.1'>http://192.168.255.1</a>.
       Configure the wireless interface with the proper name and security key.
     </p>" . PHP_EOL .
    "<a class='img' href = 'http://www.flukso.net/installation'>
       <img src='http://www.flukso.net/sites/default/files/images/step2.png'
       height='120' width='150' alt='step 2'/>
     </a>" . PHP_EOL .

    "<p><b>STEP 2: SECURING THE FLUKSOMETER</b><br/>
       Disconnect all cables from the Fluksometer.
       Find a suitable location near the fuse box to install the Fluksometer.
       Secure the Fluksometer with the plastic cable tie.
     </p>" . PHP_EOL .
    "<a class='img' href = 'http://www.flukso.net/installation'>
       <img src='http://www.flukso.net/sites/default/files/images/step3.png'
       height='120' width='150' alt='step 3'/>
     </a>" .

    "<p><b>STEP 3: ATTACHING THE CURRENT CLAMP</b><br/>
       For safety reasons, switch off the main electricity supply.
       For a single phase supply, attach the current clamp to one of the two
       cables running from the electricity meter to the fuse box.
       Close the clamp firmly.
     </p>" . PHP_EOL .
    "<a class='img' href = 'http://www.flukso.net/installation'>
       <img src='http://www.flukso.net/sites/default/files/images/step4.png'
       height='120' width='150' alt='step 4'/>
     </a>" . PHP_EOL .

    "<p><b>STEP 4: CONNECTING THE CLAMP'S SENSOR CABLE</b><br/>
       Connect the cable from the current clamp to the Fluksometer's input port.
       Take care of connecting the black and red cable as shown in the drawing
       on the left. Only apply gentle force when fastening the two screws.
     </p>" . PHP_EOL .
    "<a class='img' href = 'http://www.flukso.net/installation'>
       <img src='http://www.flukso.net/sites/default/files/images/step5.png'
       height='120' width='150' alt='step 4'/>
     </a>" . PHP_EOL .

    "<p><b>STEP 5: POWERING UP</b><br/>
       Switch the main electricity supply back on.
       Activate the Fluksometer by connecting the power plug.
     </p>"  . PHP_EOL .
    "</div>". PHP_EOL;
}

/**
 * Builds the dashboard page.
 * 
 * @param $type     The sensor type.
 * @param $interval The time interval.
 * @return the dashboard page
 */
function _logger_dashboard($type, $interval) {

  $type = $type ? $type : 'electricity';
  $interval = $interval ? $interval : 'hour';

  if (user_access('logger')) {

    drupal_set_title(t('Your power consumption'));

    $xvalue1 = _logger_get_xvalue(1);
    $xvalue2 = _logger_get_xvalue(2);
    $yvalue1 = _logger_get_yvalue(1);
    $yvalue2 = _logger_get_yvalue(2);

    $sensors = _logger_get_user_sensors($type);

    $chart = _logger_create_chart_object($interval, $type, 'logger', $sensors, array($xvalue1, $xvalue2), array($yvalue1, $yvalue2));

    return theme('logger_dashboard_area', $chart);

  } else {

    return _logger_overview($type, $interval);
  }
}

/**
 * Builds the overview page.
 *
 * @param $type     The sensor type.
 * @param $interval The time interval.
 * @return the overview page
 */
function _logger_overview($type, $interval) {

  $type = $type ? $type : 'electricity';
  $interval = $interval ? $interval : 'hour';

  drupal_set_title(t('Overall View'));

  $cache_id = 'logger_overview';
  $cache = cache_get($cache_id, 'cache_page');

  if ($cache) {
    $output = $cache->data;

  } else {

    //General explanation
    $output = theme('logger_overview_topic', NULL,
      t('<b>mySmartGrid</b> is the smart device control for your home. ' .
      'It enables you to understand your energy consumption and share your ' .
      'experiences with others.'), 'content/das-projekt');

    //Latest blogpost
    $sql = 'SELECT nid FROM {node} WHERE type = "%s" ORDER BY created DESC LIMIT 1';
    $result = db_fetch_object(db_query($sql, "blogpost"));

    if ($result) {

      $blog = node_load(array('nid' => $result->nid));

      $output .= theme('logger_overview_topic', t('Blog: ') . $blog->title, $blog->teaser, 'blog');
    }

    //Counters
    $sql = "SELECT count(*) FROM {logger_devices} d WHERE d.uid <> %d";
    $devcounter = db_result( db_query($sql, 0));

    $sql = "
      SELECT
        count(*)
      FROM
        {users} u
      WHERE
        EXISTS(
          SELECT
            1
          FROM
            {logger_devices} d
          WHERE
            d.uid = u.uid
        )";

    $usercounter = db_result( db_query($sql));

    $output .= theme('logger_overview_topic', t('Total Consumption of All Participants'),
      t('Currently, <b>@devcounter</b> Flukso devices are installed ' .
        'in <b>@usercounter</b> households. The following chart shows their ' .
        'aggregate electricity consumption.',
        array(
          '@devcounter'  => $devcounter,
          '@usercounter' => $usercounter))) . '<br>';

    cache_set($cache_id, $output, 'cache_page', time() + 1 * DAY);
  }

  $sensors = _logger_get_active_sensors($type);

  $chart = _logger_create_chart_object($interval, $type, 'overview', $sensors);

  $output .= theme('logger_dashboard_area', $chart);

  return $output;
}

/**
 * Creates an object to hold all chart parameters.
 *
 * @param $interval The time interval.
 * @param $type     The sensor type.
 * @param $context  The page where the chart is going to be placed (overview or logger).
 * @param $sensors  The sensors whose values are plotted on the chart.
 * @param $xaxis    An array containing the minimum and maximum timestamps of the x axis.
 * @param $yaxis    An array containing the minimum and maximum values of the y axis.
 * @return the chart object.
 */
function _logger_create_chart_object($interval, $type, $context, $sensors, $xaxis = array(0, 0), $yaxis = array(0, 0)) {

  module_load_include('inc', 'logger', 'logger.rrd');

  $chart = new stdClass();

  $chart->type = $type;
  $chart->interval = $interval;
  $chart->context = $context;

  if (!($xaxis[0] > 0 && $xaxis[1] > 0)) {
    $xaxis[1] = time();
    $xaxis[0] = $xaxis[1] - _logger_get_default_time_window($interval);
  }

  $chart->yaxis = $yaxis;
  $chart->xaxis = $xaxis;

  $chart->resolution = _logger_get_resolution($interval);
  $chart->period = _logger_get_period($interval, $chart->resolution, $xaxis[0], $xaxis[1]);
  $chart->offset = _logger_get_timezone_offset();
  $chart->colors = _logger_get_series_colors();

  switch ($type) {
    case 'electricity':
      switch (_logger_get_unit()) {
        case 'kw':
          $chart->unit = 'kW';
          $chart->factor = 0.001;
          break;

        case 'kwh':
          $chart->unit = 'kWh/year';
          $chart->factor = 31536;
          break;

        case 'eur':
          $chart->unit = 'euro/year';
          $chart->factor = 5676; // 18 EURcent/kWh
          break;

        case 'aud':
          $chart->unit = 'aud/year';
          $chart->factor = 5991; // 19 AUDcent/kWh
          break;

        default:
          $chart->unit = 'watt';
          $chart->factor = 3600; // 1Wh/s = 3600 W
      }
  }

  $chart->sensors = $sensors;
  $chart->file_path = _logger_compose_chart_file_path($chart);

  if (!file_exists($chart->file_path)) {

    if ($context == 'logger') {

      foreach ($sensors as &$sensor) {
        $data = logger_rrd_query_sensor($interval, $sensor, $chart->factor, $chart->offset, $chart->period, $chart->resolution);
        $chart->data[$sensor->uid][$sensor->username][$sensor->function] = $data;
      }

    } else {
      $data = logger_rrd_query_agg($interval, $sensors, $chart->factor, $chart->offset, $chart->period, $chart->resolution);
      $chart->data[0][t('All')][t('All')] = $data;
    }

    _logger_save_chart_file($chart);
  }

  return $chart;
}

/**
 * Composes an unique chart file name.
 *
 * @param $chart The chart object.
 * @return the chart file name.
 */
function _logger_compose_chart_file_path($chart) {

  $t1 = $chart->period['start'] - ($chart->period['start'] % CHART_REFRESH);
  $t2 = $chart->period['end']   - ($chart->period['end']   % CHART_REFRESH);

  $unique_id = "$chart->context $chart->type $chart->unit $chart->resolution $t1 $t2";

  foreach ($sensors as $sensor) {
    $unique_id .= ' ' . $sensor->meter;
  }

  $unique_id = md5($unique_id);

  return GRAPH_PATH . "/$chart->interval/msg-chart-$unique_id.csv";
}

/**
 * Returns an array containing all sensors either owned by the user or selected
 * by him to be plotted on the chart.
 * 
 * @param $type       The type of sensors to be returned.
 * @return the array of user sensors.
 */
function _logger_get_user_sensors($type) {

  global $user;
  $sensors = array();

  $sql = "
    SELECT
      lm.uid,
      '%s' AS username,
      lm.meter,
      lm.function,
      lm.unit,
      lu.private
    FROM
      {logger_meters} lm
      INNER JOIN {logger_users} lu ON lm.uid = lu.uid
    WHERE
      lm.uid = %d AND
      lm.type = '%s' AND
      lm.function IS NOT NULL
    ORDER BY
      lm.function";

  $result = db_query($sql, $user->name, $user->uid, $type);

  while ($sensor = db_fetch_object($result)) {
    $sensors[] = $sensor;
  }

  if (user_access('logger')) {

    $sql = "
      SELECT
        u.uid,
        u.name AS username,
        lm.meter,
        lm.function,
        lm.unit,
        lu.private
      FROM
        ((({users} u
        INNER JOIN {user_relationships} ur ON u.uid = ur.requestee_id)
        INNER JOIN {user_relationship_types} urt ON ur.rtid = urt.rtid)
        INNER JOIN {logger_meters} lm ON u.uid = lm.uid)
        INNER JOIN {logger_users} lu ON u.uid = lu.uid
      WHERE
        ur.requester_id = %d AND
        urt.name = '%s' AND
        lm.type = '%s' AND
        lm.function IS NOT NULL
      ORDER BY
        ur.rid";

    $result = db_query($sql, $user->uid, 'subscription', $type);

    while($sensor = db_fetch_object($result)) {
      $sensors[] = $sensor;
    }
  }
  return $sensors;
}

/**
 * Returns an array containing all active sensors.
 *
 * @param $type       The type of sensors to be returned.
 * @return the array of user sensors.
 */
function _logger_get_active_sensors($type) {

  $sql = "
    SELECT
      lm.meter AS meter
    FROM
      {logger_meters} lm
    WHERE
      lm.uid > 0 AND
      lm.type = '%s' AND
      lm.function IS NOT NULL";

  $result = db_query($sql, $type);

  $sensors = array();
  while ($sensor = db_fetch_object($result)) {

    $sensors[] = $sensor;
  }
  return $sensors;
}

/**
 * Saves chart to a file.
 *
 * @param $chart The chart parameters.
 */
function _logger_save_chart_file($chart) {

  $header = t('Time');
  $values = array();
  $timestamps = _logger_get_all_timestamps($chart->data);
  $s = 1;

  foreach($chart->data as $uid => $userdata) {
    foreach($userdata as $username => $sensors) {
      foreach($sensors as $sensor => $measurements) {
        $header .= ',S' . $s++;

        foreach($timestamps as $timestamp) {
          $value = $measurements[$timestamp];
          $value = $value? number_format($value, 3, '.', '') : '';
          $values[$timestamp] .= ',' . $value;
        }
      }
    }
  }

  $series = $header . PHP_EOL;
  foreach($values as $timestamp => $values_list) {
    $series .= date('Y-m-d H:i', $timestamp) . $values_list . PHP_EOL;
  }

  $fh = fopen($chart->file_path, 'w');
  fwrite($fh, $series);
  fclose($fh);
}

/**
 * Returns an array of user devices' serial numbers indexed by their respective
 * hash codes.
 *
 * @return the array of devices.
 */
function logger_get_devices_options() {

  global $user;

  $devices = array();
  if ($user->uid) {

    $sql = "SELECT serial, device FROM {logger_devices} WHERE uid = %d ORDER BY serial";
    $result = db_query($sql, $user->uid);

    while ($row = db_fetch_array($result)) {
      $devices[$row['device']] = $row['serial'];
    }
  }
  return $devices;
}

/**
 * Returns the user timezone offset.
 *
 * @return the user timezone offset.
 */
function _logger_get_timezone_offset() {

  global $user;

  if ($user->uid) {
    $offset = $user->timezone;

  } else { //If user is not logged in

    //Gets timezone used in the browser. Auto Timezone option must be turned on.
    $offset = $_SESSION['timezone'];
  }

  return $offset;
}

function logger_theme() {

  return array(
    'logger_dashboard_area' => array(
      'arguments' => array(
        'chart' => NULL),
    ),

    'logger_overview_topic' => array(
      'arguments' => array(
        'title' => NULL,
        'body' => NULL,
        'link' => NULL),
    ),

    'logger_account_devices' => array(
      'arguments' => array(
        'form' => NULL),
      'file' => 'logger.admin.inc',
    ),

    'logger_account_devices_list' => array(
      'arguments' => array(
        'items' => NULL),
      'file' => 'logger.admin.inc',
    ),

    'logger_account_sensors_list' => array(
      'arguments' => array(
        'items' => NULL),
      'file' => 'logger.admin.inc',
    ),

    'logger_smoothing_level' => array(
      'arguments' => array(
        'element' => NULL),
    ),

    'logger_value_range' => array(
      'arguments' => array(
        'element' => NULL),
    ),

    'logger_time_period' => array(
      'arguments' => array(
        'element' => NULL),
    ),
  );
}

/**
 * Builds a topic of the Overview page.
 *
 * @param $title  The topic title.
 * @param $body   The topic body.
 * @param $link   The topic link.
 * @return the topic.
 */
function theme_logger_overview_topic($title, $body, $link = NULL) {

  if($title) {
    $output .= '<br><h3 class="node-headline">' . $title . '</h3>';
  }

  $output .= "<p> $body </p>";

  if($link) {
    $output .= '<p>' . l(t('read more'), $link) . '</p>';
  }

  return $output;
}

/**
 * Builds the dashboard area.
 *
 * @param $chart   The chart parameters.
 * @return the dashboard area output.
 */
function theme_logger_dashboard_area($chart) {

  $xvalue1 = $chart->xaxis[0] * 1000;
  $xvalue2 = $chart->xaxis[1] * 1000;

  $chart_properties = array(
    'height'       => CHART_HEIGHT,
    'dateWindow'   => "[$xvalue1, $xvalue2]",
    'drawCallback' => 'updateControlForm',
    'zoomCallback' => 'updateSliderChart'
  );

  if ($chart->context == 'logger') {

    $yvalue1 = $chart->yaxis[0] + 0;
    $yvalue2 = $chart->yaxis[1] + 0;

    if ($yvalue1 >= 0 && $yvalue2 > 0) {
      $chart_properties['valueRange'] = "[$yvalue1, $yvalue2]";
    }

    $slider_output = _logger_create_dygraph('sliderChart', $chart, false, array(
        'height'           => SLIDER_HEIGHT,
        'gridLineColor'    => '"transparent"',
        'yValueFormatter'  => 'hideZeroY',
        'zoomCallback'     => 'updateMainChart',
        'clickCallback'    => 'jumpToDate',
        'underlayCallback' => 'highlightChartArea'
      )
    );

    $form_output = drupal_get_form('logger_control_form', $chart);
  }

  return
    _logger_create_interval_menu($chart->context) .
    '<div>' . $chart->unit . '</div>' .

    _logger_create_dygraph('mainChart', $chart, true, $chart_properties) .
    $slider_output .

    _logger_create_chart_legend($chart) .

    $form_output .
    l(t('Save Data'), $chart->file_path);
}

/**
 * Creates a Dygraph chart.
 *
 * @param $id             The chart div id.
 * @param $chart          The chart object.
 * @param $create_labels  If a div needs to be created to show labels.
 * @param $properties     The Dygraph properties.
 * @return the Dygraph output.
 */
function _logger_create_dygraph($id, $chart, $create_labels, $properties) {

  $properties = array_merge($properties, array(
    'labelsDiv'         => '"chartLabels"',
    'colors'            => '["' . implode('","', $chart->colors) . '"]',
    'width'             => 600,
    'yAxisLabelWidth'   => 50,
    'axisLabelFontSize' => 12,
    'includeZero'       => 'true',
    'stepPlot'          => _logger_get_step_plot(),
    'rollPeriod'        => _logger_get_smoothing_level()
  ));

  if ($create_labels) {
    $labels_output = '<div id=' . $properties['labelsDiv'] . ' style="min-height: 20px; padding-bottom: 10px;"></div>';
  }

  foreach ($properties as $key => $value) {
    $pairs[] = "$key: $value";
  }

  return '<div id="' . $id . '"></div><br>' .
    $labels_output .
    '<script type="text/javascript">' .
        $id . ' = new Dygraph(
          document.getElementById("' . $id . '"),
          "/' . $chart->file_path . '", {' .
          implode(', ', $pairs) . ' }
      );
    </script> ';
}

/**
 * Creates the chart intervals' horizontal menu.
 *
 * @param $context  The page where the menu is going to be placed (overview or logger).
 * @return the list of intervals' menus.
 */
function _logger_create_interval_menu($context) {

  $path = "$context/electricity";

  $items = array(
    l(t('Hour'),   "$path/hour"),
    l(t('Day'),    "$path/day"),
    l(t('3 Days'), "$path/days"),
    l(t('Week'),   "$path/week"),
    l(t('Month'),  "$path/month"),
    l(t('Year'),   "$path/year")
  );

  return theme_item_list($items, NULL, 'ul', array('class' => 'tabs secondary'));
}

/**
 * Creates the chart legend.
 *
 * @param $chart  The chart object.
 * @return the chart legend as a table.
 */
function _logger_create_chart_legend($chart) {

  global $user;

  $cache_id = 'logger_chart_legend_' . $chart->file_path;
  $cache = cache_get($cache_id, 'cache_page');
  if ($cache) {
    return $cache->data;
  }

  $i = 0;
  foreach($chart->data as $uid => $userdata) {
    foreach($userdata as $username => $sensors) {
      foreach($sensors as $meter => $measurements) {

        $color = $chart->colors[$i % count($chart->colors)];

        $id = SERIES_COLOR_ID . $i;
        $mark = '<input class="color {valueElement:' . "'$id'" . '} type="button"
          style="width: 10px; height: 10px;"/>
          <input id="' . $id . '" type="hidden" value="' . $color . '"
          onchange="' . "document.location='/logger/color/$i/' + escape('#' + this.value) + '?" . drupal_get_destination() . "';" . '"/>';

        $operations = ($uid > 0 && $uid != $user->uid)?
          '<a href="" OnClick="javascript:removeChartSeries(' . $uid . ');">' . t('Remove') . '</a>' : '';

        $lines[] = array(
            'mark'      => $mark,
            'user'      => $username,
            'sensor'    => $meter,
            'max'       => "<div id='max$i'  align='right'/>",
            'min'       => "<div id='min$i'  align='right'/>",
            'avg'       => "<div id='avg$i'  align='right'/>",
            'last'      => "<div id='last$i' align='right'/>",
            'operation' => $operations
        );
        $i++;
      }
    }
  }

  $headers = array(
    array('data'  => t('Color')),
    array('data'  => t('User')),
    array('data'  => t('Sensor')),
    array('data'  => t('Max')),
    array('data'  => t('Min')),
    array('data'  => t('Avg')),
    array('data'  => t('Last')),
    array('data'  => t('Operation'))
  );

  $output = '<br>' . theme('table', $headers, $lines);

  cache_set($cache_id, $output, 'cache_page', time() + 2 * CHART_REFRESH);

  return $output;
}

/**
 * Returns a sorted array of measurements' timestamps.
 *
 * @param $data  The chart series data. {user => {sensor => {timestamp => value}}}
 * @return the array of timestamps.
 */
function _logger_get_all_timestamps($data) {
  $timestamps = array();
  foreach($data as $uid => $userdata) {
    foreach($userdata as $username => $sensors) {
      foreach($sensors as $sensor => $measurements) {
        foreach(array_keys($measurements) as $timestamp) {
          $timestamps[$timestamp] = null;
        }
      }
    }
  }
  $timestamps = array_keys($timestamps);
  sort($timestamps);
  return $timestamps;
}

/**
 * Sets the chart series color.
 *
 * @param $i      The chart series' index.
 * @param $color  The new chart series' color.
 */
function _logger_series_color($i, $color) {

  global $_REQUEST;
  global $user;
  $id = SERIES_COLOR_ID . $i;

  if ($user) {
    $id .= $user->uid;
    variable_set($id, $color);

  } else {
    setcookie($id, $unit, time() + WEEK, '/');
  }

  drupal_goto($_REQUEST['destination']);
}

/**
 * Returns the list of colors used in chart series.
 *
 * @return array of colors.
 */
function _logger_get_series_colors() {

  function _get_color($i, $default) {

    global $user;
    $id = SERIES_COLOR_ID . $i;

    if ($user) {
      $id .= $user->uid;
      $color = variable_get($id, $default);

    } else {
      $color = isset($_COOKIE[$id])? $_COOKIE[$id] : $default;
    }

    return $color;
  }

  return array(
    _get_color( 0, '#377037'), //GREEN
    _get_color( 1, '#C11700'), //RED
    _get_color( 2, '#0000FC'), //BLUE
    _get_color( 3, '#F37E2B'), //ORANGE
    _get_color( 4, '#B54FC6'), //PINK
    _get_color( 5, '#665C00'), //BROWN
    _get_color( 6, '#050305'), //BLACK
    _get_color( 7, '#809090'), //GREY
    _get_color( 8, '#9ED3C0'), //REEN3
    _get_color( 9, '#00FF00'), //GREEN2
    _get_color(10, '#0080FF'), //SKYBLUE
    _get_color(11, '#00ffff'), //CYAN
    _get_color(12, '#FBEB0D'), //YELLOW
    _get_color(13, '#DED00F')  //BROWN2
    );
}

function logger_block($op = 'list', $delta = 0, $edit = array()) {

  global $user;

  switch ($op) {
    case 'list':
      $blocks['posts']['info'] = t('Recent blog posts');
      $blocks['posts']['status'] = TRUE;
      $blocks['posts']['region'] = 'right';
      $blocks['posts']['weight'] = 3;
      $blocks['posts']['pages'] = '<front>\nlogger/\nlogger/*';
      $blocks['posts']['cache'] = BLOCK_CACHE_GLOBAL;

      return $blocks;

    case 'view':

      if ($delta == 'posts' && user_access('access content')) {

        $block = _logger_create_recent_blogs_block();
      }

      return $block;
  }
}

function _logger_create_recent_blogs_block() {

  $block = array();

  $sql = "
    SELECT
      n.nid,
      n.title,
      n.created
    FROM
      {node} n
    WHERE
      n.type = 'blogpost' AND
      n.status = 1
    ORDER BY
      n.created DESC";

  $result = db_query_range(db_rewrite_sql($sql), 0, 5);
  $node_title_list = node_title_list($result);

  if ($node_title_list) {
    $block['subject'] = t('Recent blog posts');
    $block['content'] = $node_title_list;
    $block['content'] .= theme('more_link', url('blog'), t('Read the latest blog entries.'));
  }

  return $block;
}

function logger_form_contact_mail_page_alter(&$form, $form_state) {

  $devices = logger_get_devices_options();
  $options = array_flip($devices);

  $form['devices'] = array(
    '#type'          => 'select',
    '#options'       => $options,
    '#default_value' => array_keys($options),
    '#multiple'      => TRUE,
    '#size'          => 1,
    '#attributes'    => array('style' => 'visibility:hidden;'),
  );
}

function logger_mail_alter(&$message) {

  switch($message['id']) {

    case 'contact_page_mail':
      $devices = $message['params']['devices'];

      if (count($devices) > 0) {
        $message['body'][] = t("User Devices: ") . implode(', ', $devices);
      }
    break;
  }
}

function logger_control_form(&$form_state, $chart) {

  global $base_path;

  $attributes = array(
    'onchange'      => '
      document.getElementById("logger-control-form").submit();'
  );

  $form['new_user'] = array(
    '#type'           => 'select',
    '#title'          => t('Add User'),
    '#description'    => t('Select a user to be added to the chart.'),
    '#options'        => _logger_get_users_options(),
    '#default_value'  => 0,
    '#attributes'     => $attributes
  );

  $form['removed_user'] = array(
    '#type'           => 'hidden',
    '#default_value'  => 0
  );

  $form['unit'] = array(
    '#type'           => 'select',
    '#title'          => t('Chart Unit'),
    '#description'    => t('Select the chart unit.'),
    '#options'        => _logger_get_units_options(),
    '#default_value'  => _logger_get_unit(),
    '#required'       => TRUE,
    '#attributes'     => $attributes
  );

  $form['step_plot'] = array(
    '#type'           => 'checkbox',
    '#title'          => t('Stepped Lines'),
    '#description'    => t('Do you want the chart series to use stepped lines?'),
    '#default_value'  => _logger_get_step_plot(),
    '#return_value'   => 1,
    '#required'       => TRUE,
    '#attributes'     => $attributes
  );

  $form['smoothing_level'] = array(
    '#type'           => 'textfield',
    '#theme'          => 'logger_smoothing_level',
    '#title'          => t('Smoothing Level'),
    '#description'    => t("Increase this number to smooth the series' lines and make the chart more readable."),
    '#maxlength'      => 5,
    '#size'           => 5,
    '#text-align'     => 'center',
    '#default_value'  => _logger_get_smoothing_level(),
    '#required'       => TRUE,
    '#attributes'     => $attributes
  );

  $form['yvalue'] = array(
    '#type'           => 'textfield',
    '#theme'          => 'logger_value_range',
    '#title'          => t('Value Range'),
    '#description'    => t("Enter the value range shown on the Y axis, and click the Refresh button."),
    '#maxlength'      => 12,
    '#size'           => 12,
    '#text-align'     => 'right'
  );

  $form['xvalue'] = array(
    '#type'           => 'textfield',
    '#theme'          => 'logger_time_period',
    '#title'          => t('Time Period'),
    '#description'    => t("Enter the time period shown on the X axis, and click the Refresh button."),
    '#text-align'     => 'center'
  );

  $form['resolution'] = array(
    '#type'           => 'select',
    '#title'          => t('Time Resolution'),
    '#description'    => t('Select the amount of time represented by each point on the chart.'),
    '#options'        => _logger_get_resolutions_options(),
    '#attributes'     => $attributes
  );

  $form['submit'] = array(
    '#type'   => 'submit',
    '#value'  => t('Refresh')
  );
  
  return $form;
}

/**
 * Builds the Smoothing Level field.
 *
 * @param $element  The Drupal form field element.
 * @return the field HTML code.
 */
function theme_logger_smoothing_level($element) {

  function _operation_button($field, $caption, $step) {

    $onclick = "
      var field = document.getElementById('$field');
      var level = field.value - (-1 * ($step));
      field.value = level < 1? 1: level;
      field.onchange();";

    return '<input type="button" value="' . $caption . '" onclick="' . $onclick . '"/>';
  }

  $id = $element['#id'];
  $value = check_plain($element['#value']);

  $output =
    _operation_button($id, '<<', -10) .
    _operation_button($id, '<',  -1) .

    _logger_create_custom_field($element, '', $value, $attributes) .

    _operation_button($id, '>',   1) .
    _operation_button($id, '>>',  10);

  return theme('form_element', $element, $output);
}

/**
 * Builds the group of fields for informing value range.
 *
 * @param $element  The Drupal form field element.
 * @return the field HTML code.
 */
function theme_logger_value_range($element) {

  $field1 = _logger_create_custom_field($element, 1, '');
  $field2 = _logger_create_custom_field($element, 2, '');

  return _logger_compose_range_fields($element, $field1, $field2);
}

/**
 * Builds the group of fields for informing a time period.
 *
 * @param $element  The Drupal form field element.
 * @return the field HTML code.
 */
function theme_logger_time_period($element) {

  $field1 = _logger_create_time_fields($element, 1);
  $field2 = _logger_create_time_fields($element, 2);

  return _logger_compose_range_fields($element, $field1, $field2);
}

/**
 * Creates two fields to represent a timestamp: one for date and another for time.
 *
 * @param $element  The Drupal form field element.
 * @param $sufix    A sufix for the field id and name.
 * @return the fields HTML code.
 */
function _logger_create_time_fields($element, $sufix) {

  $picker_properties = "{
      yearRange: '-1:+0',
      showAnim: 'fadeIn',
      dateFormat: 'dd/mm/yy',
      currentText: '" . t('Today') . "',
      nextText: '" . t('Next Month') . "',
      prevText: '" . t('Previous Month') . "',
      dayNamesMin: [" . t("'Su','Mo','Tu','We','Th','Fr','Sa'") . "],
      monthNames: ['" . t('January') . "', '" . t('February') . "', '" . t('March') . "', '" . t('April') . "', '" . t('May') . "', '" . t('June') . "', '" . t('July') . "', '" . t('August') . "', '" . t('September') . "', '" . t('October') . "', '" . t('November') . "', '" . t('December') . "']
    }";

  drupal_add_js('$(document).ready(function(){$("#edit-xvalue' . $sufix . 'date").datepicker('. $picker_properties .');});', 'inline');

  return
    _logger_create_custom_field($element, $sufix . 'date', '', 10, 10) .
    _logger_create_custom_field($element, $sufix . 'time', '', 5, 5);
}

/**
 * Arrange fields to represent a range.
 * 
 * @param $element  The Drupal form field element.
 * @param $field1   The field that contains the lowest value.
 * @param $field2   The field that contains the highest value.
 * @return the fields HTML code.
 */
function _logger_compose_range_fields($element, $field1, $field2) {

  $output = t('from: ') . $field1 . ' &nbsp;&nbsp;&nbsp;' . t('to: ') . $field2;
  return theme('form_element', $element, $output);
}

/**
 * Create a customized form field.
 * 
 * @param $element     The Drupal form field element.
 * @param $sufix       A sufix for the field id and name.
 * @param $value       The field value.
 * @param $size        The field size.
 * @param $maxlength   The field maximum length.
 * @return the field HTML code.
 */
function _logger_create_custom_field($element, $sufix, $value, $size = 0, $maxlength = 0) {

  $name      = $element['#name'] . $sufix;
  $id        = $element['#id']   . $sufix;
  $align     = $element['#text-align'] . ';';
  $size      = $size > 0 ? $size : $element['#size'];
  $maxlength = $maxlength > 0 ? $maxlength : $element['#maxlength'];

  $attributes = isset($element['#attributes']) ? drupal_attributes($element['#attributes']) : '';

  return
    '<input type="text" ' .
    'name="'              . $name      . '" ' .
    'id="'                . $id        . '" ' .
    'maxlength="'         . $maxlength . '" ' .
    'size="'              . $size      . '" ' .
    'value="'             . $value     . '" ' .
    'style="text-align: ' . $align     . '" ' .
    $attributes . ' />';
}

function logger_control_form_validate($form, &$form_state) {

  $smoothing_level = $form_state['values']['smoothing_level'];

  if ($smoothing_level < 1) {
    form_set_error('smoothing_level', t('The smoothing level must be greater than 0.'));
  }

  $step_plot = $form_state['values']['step_plot'];

  if ($step_plot != 1 && $step_plot != 0) {
    form_set_error('step_plot', t('The stepped lines option must be either 0 or 1.'));
  }

  $yvalue1 = _logger_get_yvalue(1);
  $yvalue2 = _logger_get_yvalue(2);

  if (!($yvalue1 >= 0 && $yvalue2 > 0 && $yvalue2 > $yvalue1)) {

    form_set_error('yvalue', t('The value range is invalid.'));
  }

  $xvalue1 = _logger_get_xvalue(1);
  $xvalue2 = _logger_get_xvalue(2);

  if (!($xvalue1 > 0 && $xvalue2 > 0 && $xvalue2 > $xvalue1)) {

    form_set_error('xvalue', t('Time period is invalid.'));
  }
}

function logger_control_form_submit($form, &$form_state) {

  global $_REQUEST;
  
  $new_user        = $form_state['values']['new_user'];
  $removed_user    = $form_state['values']['removed_user'];
  $unit            = $form_state['values']['unit'];
  $step_plot       = $form_state['values']['step_plot'];
  $smoothing_level = $form_state['values']['smoothing_level'];

  if ($new_user > 0) {
    _logger_add_user($new_user);
  }

  if ($removed_user > 0) {
    _logger_remove_user($removed_user);
  }

  _logger_set_unit($unit);
  _logger_set_step_plot($step_plot);
  _logger_set_smoothing_level($smoothing_level);

  $form_state['redirect'] = array($_GET['q'], $_REQUEST);
}

/**
 * Returns an array of units indexed by their respective acronym.
 *
 * @return the array of units.
 */
function _logger_get_units_options() {

  return array(
    'watt' => t('watt'),
    'kwh'  => t('kWh/year'),
    'eur'  => t('euro/year [@ 0.18eur/kWh]'),
    'aud'  => t('aud/year [@ 0.19aud/kWh]')
  );
}

/**
 * Sets the chart unit.
 *
 * @param $unit  The new unit.
 */
function _logger_set_unit($unit) {

  global $user;
  $id = CHART_UNIT;

  if ($user) {
    $id .= $user->uid;
    variable_set($id, $unit);

  } else {
    setcookie($id, $unit, time() + WEEK, '/');
  }
}

/**
 * Returns the chart unit.
 *
 * @return the chart unit.
 */
function _logger_get_unit() {

  global $user;
  $id = CHART_UNIT;

  if ($user) {
    $id .= $user->uid;
    $unit = variable_get($id, 'watt');

  } else {
    $unit = isset($_COOKIE[$id])? $_COOKIE[$id] : 'watt';
  }
  return $unit;
}

/**
 * Sets the chart smooting level.
 *
 * @param $level  The new smooting level.
 */
function _logger_set_smoothing_level($level) {

  global $user;
  $id = SMOOTHING_LEVEL_ID . $user->uid;

  variable_set($id, $level);
}

/**
 * Returns the chart smooting level.
 *
 * @return The chart smooting level.
 */
function _logger_get_smoothing_level() {

  global $user;

  if ($user) {
    $id = SMOOTHING_LEVEL_ID . $user->uid;
    $level = variable_get($id, 1);

  } else {
    $level = 1;
  }

  return $level;
}

/**
 * Returns whether the chart is stepped or not.
 *
 * @return 1 if it is, 0 otherwise.
 */
function _logger_get_step_plot() {

  global $user;

  if ($user) {
    $id = STEP_PLOT_ID . $user->uid;
    $step_plot = variable_get($id, 0);

  } else {
    $step_plot = 0;
  }

  return $step_plot;
}

/**
 * Sets  whether the chart is stepped or not.
 *
 * @param $step_plot  1 if it is, 0 otherwise.
 */
function _logger_set_step_plot($step_plot) {

  global $user;
  $id = STEP_PLOT_ID . $user->uid;

  variable_set($id, $step_plot);
}

/**
 * Returns either the lowest or the highest value shown on the Y axis.
 *
 * @param $index Inform 1 for the lowest, 2 for the highest.
 *
 * @return the value.
 */
function _logger_get_yvalue($index) {
  return $_REQUEST['yvalue' . $index];
}

/**
 * Returns either the lowest or the highest value shown on the X axis.
 *
 * @param $index Inform 1 for the lowest, 2 for the highest.
 *
 * @return the value.
 */
function _logger_get_xvalue($index) {
  
  $formatted = $_REQUEST['xvalue' . $index. 'date'] . ' ' . $_REQUEST['xvalue' . $index. 'time'];

  //Parses a datetime string formatted as dd/mm/yyyy hh:mm to a Unix timestamp.
  
  $str = "$formatted:00 GMT+00:00";
  $d = strtok($str, '/');
  $m = strtok('/');
  $r = strtok('/');

  $timestamp = strtotime("$m/$d/$r");
  $timestamp -= _logger_get_timezone_offset();
  
  return $timestamp > 0 ? $timestamp : 0;
}

/**
 * Returns the chart resolution of a time interval menu option.
 *
 * @param $interval  The time interval menu option.
 * @return the chart resolution.
 */
function _logger_get_resolution($interval) {

  $resolution = $_REQUEST['resolution'];
  if ($resolution > 0) {
    return $resolution;
  }

  $options = array(
    'hour'  =>  1 * MINUTE,
    'day'   => 15 * MINUTE,
    'days'  => 15 * MINUTE,
    'week'  => 15 * MINUTE,
    'month' =>  1 * DAY,
    'year'  =>  1 * WEEK
  );

  return $options[$interval];
}

/**
 * Returns an array of chart resolutions.
 *
 * @return the array of chart resolutions.
 */
function _logger_get_resolutions_options() {

  return array(
     1 * MINUTE =>  1 . ' ' . t('Minute'),
    15 * MINUTE => 15 . ' ' . t('Minutes'),
     1 * DAY    =>  1 . ' ' . t('Day'),
     1 * WEEK   =>  1 . ' ' . t('Week')
  );
}

/**
 * Returns the default time window associated with a time interval menu option.
 *
 * @param $interval  The time interval menu option.
 * @return the amount of seconds of the time window.
 */
function _logger_get_default_time_window($interval) {

  $windows = array(
    'hour'  =>  1 * HOUR,
    'day'   =>  1 * DAY,
    'days'  =>  3 * DAY,
    'week'  =>  1 * WEEK,
    'month' => 60 * DAY,
    'year'  =>  1 * YEAR
  );
  return $windows[$interval];
}

/**
 * Returns an array containing two timestamps representing a period of time.
 *
 * @param $interval    The time interval menu option.
 * @param $resolution  The time resolution.
 * @param $start       The initial timestamp, if known.
 * @param $end         The final timestamp, if known.
 * @return the period of time as an array.
 */
function _logger_get_period($interval, $resolution, $start = 0, $end = 0) {

  module_load_include('inc', 'logger', 'logger.rrd');
  $now = time();

  if ($start > 0 && $end > 0) {
    $window = $end - $start;

  } else {
    $window = _logger_get_default_time_window($interval);
    $end = $now;
  }

  $storage_periods = logger_get_storage_periods();
  $elapsed_time = $now - $end;
  $max_window = $storage_periods[$resolution] - $elapsed_time;

  $window *= (CHART_HEIGHT / SLIDER_HEIGHT);
  $window = $window > $max_window ? $max_window : $window;

  $start = $end - $window;

  return array(
    'start' => $start,
    'end'   => $end
  );
}

/**
 * Returns an array of fluksonian users indexed by their respective user id.
 * Only users not yet plotted on the chart are returned.
 *
 * @return the array of fluksonian users.
 */
function _logger_get_users_options() {

  global $user;

  $sql = "
    SELECT
      f.uid,
      f.name
    FROM
      {users} f,
      {users_roles} ur,
      {role} r
    WHERE
      f.uid <> %d AND
      f.uid = ur.uid AND
      ur.rid = r.rid AND
      r.name = '%s' AND
      NOT EXISTS(
        SELECT
          1
        FROM
          {user_relationships} urel,
          {user_relationship_types} t
        WHERE
          t.name = '%s' AND
          urel.rtid = t.rtid AND
          urel.requestee_id = f.uid AND
          urel.requester_id = %d
      )
    ORDER BY
      f.name";

  $fluksonians = db_query($sql, $user->uid, 'fluksonian', 'subscription', $user->uid);

  $options = array(0 => '');
  while($fluksonian = db_fetch_object($fluksonians)) {
    $options[$fluksonian->uid] = $fluksonian->name;
  }
  return $options;
}

/**
 * Adds an user to the chart.
 *
 * @param $uid  The id of the user to be added.
 */
function _logger_add_user($uid) {

  global $user;

  // don't allow users to add themselves
  if ($uid != $user->uid) {

    $sql = "SELECT rtid FROM {user_relationship_types} WHERE name = '%s'";
    $rtid = db_result(db_query($sql, 'subscription'));

    user_relationships_request_relationship($user->uid, $uid, $rtid, TRUE);
  }
}

/**
 * Removes an user from the chart.
 *
 * @param $requestee_id  The id of the user to be removed.
 */
function _logger_remove_user($requestee_id) {

  global $_REQUEST;
  global $user;

  $sql = "
    DELETE
      FROM {user_relationships}
    WHERE
      requester_id = %d AND
      requestee_id = %d";

  db_query($sql, $user->uid, $requestee_id);
}

function logger_form_alter(&$form, &$form_state, $form_id) {

  if ($form_id == 'user_login') {
    $form['#redirect'] = 'logger';
    $form['name']['#size'] = 20;
    $form['pass']['#size'] = 20;
  }
}

/**
 * Access callback ensuring the user account tabs are visible only to the owner.
 *
 * @param $permission Required permission to view the item.
 * @param $account    A user object.
 */
function _logger_account_access($permission, $account) {
  return ($account->uid == $GLOBALS['user']->uid && user_access($permission));
}

/**
 * Access callback ensuring the sensor is accessible only to the owner.
 */
function _logger_sensor_access($permission, $meter) {

  $sql = "SELECT uid FROM {logger_meters} WHERE meter = '%s'";

  $sensor = db_fetch_object(db_query($sql, $meter));

  return ($sensor->uid == $GLOBALS['user']->uid && user_access($permission));
}

/**
 * Access callback ensuring the device is accessible only to the owner.
 */
function _logger_device_access($permission, $serial) {

  $sql = "SELECT uid FROM {logger_devices} WHERE serial = %d";

  $device = db_fetch_object(db_query($sql, $serial));

  return ($device->uid == $GLOBALS['user']->uid && user_access($permission));
}

/**
 * Queries the databases for measurements reported by sensors of a single device.
 *
 * @param $interval The time interval.
 * @param $device   The device's hash code.
 * @param $offset   The user timezone offset.
 * @return the array of sensors' measurements, formatted as [meter][function][ [timestamp, value] ].
 */
function logger_query_device_measurements($interval, $device, $offset) {

  module_load_include('inc', 'logger', 'logger.rrd');

  $sql = "SELECT m.meter, m.function FROM {logger_meters} m WHERE m.device = '%s'";
  $sensors = db_query($sql, $device);
  $measurements = array();

  $resolution = _logger_get_resolution($interval);
  $period = _logger_get_period($interval, $resolution);

  while($sensor = db_fetch_object($sensors)) {

    $measurements[$sensor->meter][$sensor->function] = logger_rrd_query_sensor($interval, $sensor, 3600, $offset, $period, $resolution);
  }
  return $measurements;
}

function logger_cron() {

  $intervals = array('hour', 'day', 'days', 'week', 'month', 'year', 'night');

  //This limit prevents chart files from being removed before they are sent to the user.
  $age = 2 * CHART_REFRESH / MINUTE;

  foreach($intervals as $interval) {

    exec('find ' . GRAPH_PATH . "/$interval/* -mmin +$age -exec rm {} \;");
  }
}