<?php

/**
 * This module manages Flukso devices' event notifications.
 *
 * Copyright (c) 2010 Fraunhofer Institut ITWM (www.itwm.fraunhofer.de)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

//Constants
define('NO_COMMUNICATION_EVENT_ID',       1);
define('CORRUPTED_MESSAGE_EVENT_ID',      2);
define('COMMUNICATION_RESTORED_EVENT_ID', 3);
define('PEAK_CONSUMPTION_EVENT_ID',       4);
define('BROWNOUT_EVENT_ID',               5);
define('HEARTBEAT_RECEIVED_EVENT_ID',     6);
define('MEASUREMENT_RECEIVED_EVENT_ID',   7);

define('HOUR_UNIT_ID', 2);
define('WATT_UNIT_ID', 3);

define('NOTIFICATION_PATH', 'sites/all/modules/notification');
define('NOTIFICATION_TIMESTAMP_FORMAT_SQL', '%d-%m-%Y %H:%i:%s');
define('NOTIFICATION_TIMESTAMP_FORMAT_PHP', 'd-m-Y H:i');


function notification_init() {
  drupal_add_js(NOTIFICATION_PATH . '/js/notification.js');
}

function notification_perm() {
  return array(
    'list event notifications',
    'view event notifications',
    'save event notifications',
    'delete event notifications',
    'list event logs',
    'delete event logs'
  );
}

function notification_settings_access($permission, $account) {
  return ($account->uid == $GLOBALS['user']->uid && user_access($permission));
}

function notification_menu() {

  $items['notification/list'] = array(
    'title'             => 'Event Notifications',
    'page callback'     => 'notification_list_page',
    'access arguments'  => array('list event notifications'),
    'type'              => MENU_NORMAL_ITEM
  );

  $items['notification/delete'] = array(
    'title'             => $items['notification/list']['title'],
    'page callback'     => 'notification_delete',
    'page arguments'    => array(2, 3, 4, 5),
    'access arguments'  => array('delete event notifications'),
    'type'              => MENU_CALLBACK
  );

  $items['notification/register'] = array(
    'title'             => 'Event Notification Registration',
    'page callback'     => 'drupal_get_form',
    'page arguments'    => array('notification_registration_form'),
    'access arguments'  => array('view event notifications'),
    'type'              => MENU_CALLBACK
  );

  $items['notification/edit'] = array(
    'title'             => 'Event Notification Edition',
    'page callback'     => 'notification_edition_page',
    'page arguments'    => array(2, 3, 4, 5),
    'access arguments'  => array('view event notifications'),
    'type'              => MENU_CALLBACK
  );

  $items['event/log/list'] = array(
    'title'             => 'Device History',
    'page callback'     => 'notification_eventlog_page',
    'page arguments'    => array(3),
    'access arguments'  => array('list event logs'),
    'type'              => MENU_CALLBACK
  );

  $items['event/log/clear'] = array(
    'title'             => $items['event/log/list']['title'],
    'page callback'     => '_notification_eventlog_clear',
    'page arguments'    => array(3),
    'access arguments'  => array('delete event logs'),
    'type'              => MENU_CALLBACK
  );

  $items['newsletter'] = array(
    'title'             => 'Newsletter',
    'page callback'     => 'notification_newsletter_page',
    'access callback'   => TRUE,
    'type'              => MENU_NORMAL_ITEM
  );
  return $items;
}

/**
 * Event notification deletion callback.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @param $limit_up  The event's threshold.
 * @param $unit_id   The unit id.
 * @return the events list page.
 */
function notification_delete($device, $event_id, $limit_up, $unit_id) {

  _notification_delete($device, $event_id, $limit_up, $unit_id);
  return notification_list_page();
}

/**
 * Builds the event notification edition page.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @param $limit_up  The event's threshold.
 * @param $unit_id   The unit id.
 * @return the event notification edition page.
 */
function notification_edition_page($device, $event_id, $limit_up, $unit_id) {

  $sql = "
    SELECT
      e.id AS event_id,
      e.name AS event_name,
      n.device,
      d.serial,
      n.emails,
      n.min_interval,
      n.limit_up,
      n.unit_id
    FROM
      {event} e,
      {notification} n,
      {logger_devices} d
    WHERE
      d.device = '%s' AND
      d.device = n.device AND
      n.event_id = e.id AND
      e.id = %d AND
      n.limit_up = %d AND
      n.unit_id = %d";

  $notification = db_fetch_object(db_query($sql, $device, $event_id, $limit_up, $unit_id));

  return drupal_get_form('notification_edition_form', $notification);
}

/**
 * Builds the events list page.
 *
 * @return the events list page.
 */
function notification_list_page() {

  $sql = "
    SELECT
      d.serial,
      e.name AS event_name,
      n.emails,
      IF(n.last_sent = 0, NULL, FROM_UNIXTIME(n.last_sent + u.timezone, '%s')) AS last_sent,
      n.limit_up,
      un.id AS unit_id,
      un.symbol AS unit,
      d.device,
      e.id AS event_id
    FROM
      {users} u,
      {logger_devices} d,
      {notification} n,
      {event} e,
      {unit} un
    WHERE
      u.uid = d.uid AND
      d.uid = %d AND
      d.device = n.device AND
      n.event_id = e.id AND
      n.unit_id = un.id";

  $headers = array(
    array('data' => t('Device'),         'field' => 'serial',     'sort' => 'ASC'),
    array('data' => t('Event'),          'field' => 'event_name', 'sort' => 'ASC'),
    array('data' => t('Target e-mails'), 'field' => 'emails'),
    array('data' => t('Sent'),           'field' => 'last_sent'),
    array('data' => t('Operation'))
  );

  $sql .= tablesort_sql($headers);

  global $user;
  $result = db_query($sql, NOTIFICATION_TIMESTAMP_FORMAT_SQL, $user->uid);

  $rows = array();
  while ($object = db_fetch_array($result)) {

    $event_name = t($object['event_name']) . ($object['unit_id'] == 0? '' :
      '<br>(' . $object['limit_up'] . ' ' . t($object['unit']) . ')');

    $id = $object['device'] . '/' . $object['event_id'] . '/' . $object['limit_up'] . '/' . $object['unit_id'];

    $emails = implode("<br>", _notification_tokenize_emails($object['emails']));

    $row = array();
    $row['serial'] = $object['serial'];
    $row['event_name'] = $event_name;
    $row['emails'] = $emails;
    $row['last_sent'] = $object['last_sent'];
    $row[] = l(t('Remove'), "notification/delete/$id") . '<br>' .
             l(t('Edit'),   "notification/edit/$id");

    $rows[] = $row;
  }

  $caption = '<p>' . l(t('Register Notification'), 'notification/register') . '</p>';

  return theme('table', $headers, $rows, array(), $caption);
}

/**
 * Builds the event log page.
 *
 * @param $serial  The device serial number.
 *
 * @return the event log page.
 */
function notification_eventlog_page($serial) {

  $sql = "
    SELECT
      FROM_UNIXTIME(l.time + u.timezone, '%s') AS time,
      e.name
    FROM
      {users} u,
      {logger_devices} d,
      {event} e,
      {event_log} l
    WHERE
      l.event_id = e.id AND
      l.device = d.device AND
      d.serial = '%s' AND
      d.uid = u.uid";

  $args = array(NOTIFICATION_TIMESTAMP_FORMAT_SQL, $serial);

  $headers = array(
    array('data' => t('Time'),  'field' => 'time', 'sort' => 'DESC'),
    array('data' => t('Event'), 'field' => 'name', 'sort' => 'ASC'),
  );

  $sql_count = "
    SELECT
      COUNT(*)
    FROM
      {logger_devices} d,
      {event_log} l
    WHERE
      l.device = d.device AND
      d.serial = '$serial'";

  $sql .= tablesort_sql($headers);

  $limit = 20;
  $result = pager_query($sql, $limit, 0, $sql_count, $args);
  $rows = array();

  while ($entry = db_fetch_array($result)) {
    $rows[] = array(
      'time' => $entry['time'],
      'name' => t($entry['name'])
    );
  }

  $caption = '<p>' . t('Serial Number') . ': ' . $serial . '</p>' . '<p>' .
    l(t('Clear'), 'event/log/clear/' . $serial) . '</p>';

  return theme('table', $headers, $rows, array(), $caption) .
    theme('pager', NULL, $limit, 0);
}

/**
 * Processes the event log deletion request.
 *
 * @param $serial The device serial number.
 * @return the event log page.
 */
function _notification_eventlog_clear($serial) {

  $sql = "
    DELETE FROM
      {event_log}
    WHERE
      device = (
        SELECT
          d.device
        FROM
          {logger_devices} d
        WHERE
          d.serial = '%s'
      )";

  db_query($sql, $serial);

  return notification_eventlog_page($serial);
}

/**
 * Removes log entries older than 1 week.
 *
 * @param $now The event checkup time.
 */
function _notification_eventlog_clear_old($now) {

  $sql = "DELETE FROM {event_log} WHERE time < %d";
  db_query($sql, $now - WEEK);
}

/**
 * Logs the "brownout" event.
 *
 * @param $device  The device where the event occurred.
 */
function notification_log_brownout($device) {

  _notification_log_event(BROWNOUT_EVENT_ID, $device);
}

/**
 * Logs the "heartbeat received" event.
 *
 * @param $device  The device where the event occurred.
 */
function notification_log_heartbeat_received($device) {

  _notification_log_event(HEARTBEAT_RECEIVED_EVENT_ID, $device);
}

/**
 * Logs the "measurement received" event.
 *
 * @param $device  The device where the event occurred.
 */
function notification_log_measurement_received($device) {

  _notification_log_event(MEASUREMENT_RECEIVED_EVENT_ID, $device);
}

/**
 * Logs the "corrupted message" event.
 *
 * @param $device  The device where the event occurred.
 */
function notification_log_corrupted_message($device) {

  _notification_log_event(CORRUPTED_MESSAGE_EVENT_ID, $device);
}

/**
 * Logs an event.
 *
 * @param $event_id  The event id.
 * @param $device    The device where the event occurred.
 */
function _notification_log_event($event_id, $device) {

  $sql = "INSERT INTO {event_log} (device, event_id, time) VALUES ('%s', %d, %d)";
  db_query($sql, $device, $event_id, time());
}

/**
 * Builds the newsletter registration page.
 *
 * @return the newsletter registration page.
 */
function notification_newsletter_page() {

  $output = '<div><p>' .
    t('We would also like to keep up to date via email. Please use the form below to sign up for our newsletter.') .
    '<br><br></p></div>';

  $output .= drupal_get_form('notification_newsletter_form');

  $output .= '<div><p><br><br><br>' .
    t('Of course, we do not share this information with anyone at any given time. If you want to unsubscribe, please click the appropriate link found at the end of each newsletter.') .
    '</p></div>';

  $output .= '<div><p><br>' .
    t('Latest publications:');

  $sql = '
    SELECT
      n.nid
    FROM
      {node} n,
      {users} u,
      {users_roles} ur
    WHERE
      n.type = "%s" AND
      n.title LIKE "%s" AND
      n.uid = u.uid AND
      u.uid = ur.uid AND
      ur.rid = %d
    ORDER BY
      n.created DESC LIMIT 3';

  $results = db_query($sql, "blogpost", "Newsletter %/%", 8); //Posted by a Blogger
  while ($result = db_fetch_object($results)) {

    $blog = node_load(array('nid' => $result->nid));
    $output .= '&nbsp;&nbsp;&nbsp;' . l($blog->title, 'node/' . $blog->nid);
  }
  $output .= '</p></div>';

  return $output;
}

function notification_registration_form() {

  global $user;

  $form['device'] = array(
    '#type'        => 'select',
    '#title'       => t('Serial Number'),
    '#description' => t('Select the serial number of the monitored device.'),
    '#options'     => logger_get_devices_options()
  );

  $form['emails'] = array(
    '#type'             => 'textarea',
    '#title'            => t('E-mails'),
    '#description'      => t('Enter the e-mails to which the notification will be sent. The emails must be specified either in multiple lines or separated by space.'),
    '#rows'             => 3,
    '#resizable'        => FALSE,
    '#default_value'    => $user->mail,
    '#element_validate' => array('notification_emails_validate')
  );

  $form['events'] = array(
    '#type'   => 'fieldset',
    '#title'  => t('Events'),
    '#prefix' => '<br><table width="100%">',
    '#suffix' => '</table>'
  );

  $form['events'] += _notification_create_event_fields(NO_COMMUNICATION_EVENT_ID, 2, HOUR_UNIT_ID,
    'Here you can set the maximum message delay. Beyond this limit, the device is considered faulty.');
  
  $form['events'] += _notification_create_event_fields(COMMUNICATION_RESTORED_EVENT_ID, 2, HOUR_UNIT_ID,
    'Here you can set the maximum message delay. Beyond this limit, the device is considered faulty. When it resumes sending messages, the communication is considered restablished.');

  $form['events'] += _notification_create_event_fields(PEAK_CONSUMPTION_EVENT_ID, 5000, WATT_UNIT_ID,
    'Here you can set the maximum electricity consumption. Beyond this limit, the device is considered faulty.');

  $form['events']['event_id2'] = array(
    '#title'         => _notification_get_event_name(CORRUPTED_MESSAGE_EVENT_ID),
    '#type'          => 'checkbox',
    '#default_value' => FALSE,
    '#prefix'        => '<tr><td colspan="3"/>',
    '#suffix'        => '</tr>'
  );

  $form['min_interval'] = array(
    '#type'          => 'select',
    '#title'         => t('Amount of Notifications'),
    '#description'   => t('How often do you want to receive notifications, when the same event occurs several times consecutively?'),
    '#default_value' => 0,
    '#required'      => TRUE,
    '#options'       => _notification_get_frequency_options()
  );

  $form['submit'] = array(
    '#type'   => 'submit',
    '#value'  => t('Save'),
  );
  return $form;
}

function _notification_create_event_fields($event_id, $default_limit_up, $default_unit_id, $limit_up_description) {

  return array(
    "event_id$event_id" => array(
      '#title'         => _notification_get_event_name($event_id),
      '#type'          => 'checkbox',
      '#default_value' => FALSE,
      '#prefix'        => '<tr><td>',
      '#suffix'        => '</td>',
      '#attributes'    => array('onchange' => "selectEvent($event_id, $default_limit_up, $default_unit_id, this)")
    ),

    "limit_up$event_id" => array(
      '#type'             => 'textfield',
      '#description'      => t($limit_up_description),
      '#maxlength'        => 9,
      '#size'             => 12,
      '#prefix'           => '<td>',
      '#suffix'           => '</td>',
      '#related_event_id' => $event_id,
      '#element_validate' => array('notification_limit_up_validate'),
      '#attributes'       => array('onfocus' => "changeLimitUp($event_id, this)")
    ),

    "unit_id$event_id" => array(
      '#type'          => 'select',
      '#prefix'        => '<td width="200">',
      '#suffix'        => '</td></tr>',
      '#default_value' => $default_unit_id,
      '#required'      => TRUE,
      '#options'       => _notification_get_units_options($event_id),
    )
  );
}

function notification_edition_form(&$form_state, $notification) {

  $form['device'] = array(
    '#type'              => 'hidden',
    '#required'          => TRUE,
    '#default_value'     => $notification->device,
  );

  $form['event_id'] = array(
    '#type'              => 'hidden',
    '#default_value'     => $notification->event_id,
  );

  $form['old_limit_up'] = array(
    '#type'              => 'hidden',
    '#default_value'     => $notification->limit_up,
  );

  $form['old_unit_id'] = array(
    '#type'              => 'hidden',
    '#default_value'     => $notification->unit_id,
  );

  $form['event_name'] = array(
    '#type'              => 'textfield',
    '#title'             => t('Event'),
    '#required'          => TRUE,
    '#default_value'     => t($notification->event_name),
    '#attributes'        => array('readOnly' => 'true')
  );

  $form['serial'] = array(
    '#type'              => 'textfield',
    '#title'             => t('Serial Number'),
    '#required'          => TRUE,
    '#default_value'     => $notification->serial,
    '#attributes'        => array('readOnly' => 'true')
  );

  $form['emails'] = array(
    '#type'              => 'textarea',
    '#title'             => t('E-mails'),
    '#description'       => t('Enter the e-mails to which the notification will be sent. The emails must be specified either in multiple lines or separated by space.'),
    '#rows'              => 3,
    '#resizable'         => FALSE,
    '#required'          => TRUE,
    '#default_value'     => $notification->emails,
    '#element_validate'  => array('notification_emails_validate')
  );

  $form['limit_up'] = array(
    '#type'              => 'textfield',
    '#required'          => TRUE,
    '#maxlength'         => 9,
    '#size'              => 12,
    '#prefix'            => '<table border="0"><tr><td>',
    '#suffix'            => '</td>',
    '#default_value'     => $notification->limit_up,
    '#element_validate'  => array('notification_limit_up_validate'),
  );

  switch ($notification->event_id) {
    case NO_COMMUNICATION_EVENT_ID:
      $form['limit_up']['#title'] = t('Maximum Delay');
      $form['limit_up']['#description'] = t('Here you can set the maximum message delay. Beyond this limit, the device is considered faulty.');
      break;

    case COMMUNICATION_RESTORED_EVENT_ID:
      $form['limit_up']['#title'] = t('Maximum Delay');
      $form['limit_up']['#description'] = t('Here you can set the maximum message delay. Beyond this limit, the device is considered faulty. When it resumes sending messages, the communication is considered restablished.');
      break;

    case PEAK_CONSUMPTION_EVENT_ID:
      $form['limit_up']['#title'] = t('Maximum Consumption');
      $form['limit_up']['#description'] = t('Here you can set the maximum electricity consumption. Beyond this limit, the device is considered faulty.');
      break;
  }

  if ($notification->event_id <> CORRUPTED_MESSAGE_EVENT_ID) {

    $form['unit_id'] = array(
      '#type'           => 'select',
      '#required'       => TRUE,
      '#prefix'         => '<td width="150">',
      '#suffix'         => '</td></tr></table>',
      '#default_value'  => $notification->unit_id,
      '#options'        => _notification_get_units_options($notification->event_id),
    );
  }

  $form['min_interval'] = array(
    '#type'           => 'select',
    '#title'          => t('Amount of Notifications'),
    '#description'    => t('How often do you want to receive notifications, when the same event occurs several times consecutively?'),
    '#required'       => TRUE,
    '#options'        => _notification_get_frequency_options(),
    '#default_value'  => $notification->min_interval,
  );

  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Save'),
  );
  return $form;
}

function notification_newsletter_form() {

  $form['email'] = array(
    '#type'             => 'textfield',
    '#title'            => t('E-mail'),
    '#description'      => t('Enter your e-mail.'),
    '#maxlength'        => 64,
    '#size'             => 20,
    '#required'         => 1,
    '#element_validate' => array('notification_email_validate'),
  );

  $form['firstname'] = array(
    '#type'             => 'textfield',
    '#title'            => t('First Name'),
    '#description'      => t('Enter your first name.'),
    '#maxlength'        => 20,
    '#required'         => 1,
    '#size'             => 20,
  );

  $form['lastname'] = array(
    '#type'             => 'textfield',
    '#title'            => t('Last Name'),
    '#description'      => t('Enter your last name.'),
    '#maxlength'        => 20,
    '#required'         => 1,
    '#size'             => 20,
  );

  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t("Subscribe"),
  );
  return $form;
}

function notification_email_validate($field, $form_state) {
  if (!valid_email_address($form_state['values']['email'])) {
    form_error($field, t('Invalid e-mail address.'));
  }
}

function notification_emails_validate($field, $form_state) {

  $emails = _notification_tokenize_emails($form_state['values']['emails']);

  if (count($emails) > 10) {
    form_error($field, t('Inform at most 10 e-mails.'));
  }

  foreach($emails as $email) {

    if (!valid_email_address($email)) {

      form_error($field, t('Invalid e-mail address.'));
      return;
    }
  }
}

function notification_limit_up_validate($field, $form_state) {

  //Checkbox field
  $related_event_id = $field['#related_event_id'];
  $selected = $form_state['values']["event_id$related_event_id"];

  //If selected
  if ($selected) {

    $limit_up = $form_state['values']["limit_up$related_event_id"];
    $unit_id = $form_state['values']["unit_id$related_event_id"];

    $factor = db_result(db_query("SELECT factor FROM {unit} un WHERE id = %d", $unit_id));
    $converted_limit = $limit_up * $factor;

    if ($related_event_id == NO_COMMUNICATION_EVENT_ID && $converted_limit < 30 * MINUTE) {

      form_error($field, t('Delay time can not be less than 30 minutes.'));

    } else if ($related_event_id == PEAK_CONSUMPTION_EVENT_ID && $converted_limit <= 0) {

      form_error($field, t('Peak consumption can not be lesser than 0 watt / min.'));
    }
  }
}

function notification_registration_form_validate($form, &$form_state) {

  if (!user_access('save event notifications')) {
    form_set_error('', t('Operation not allowed.'));
  }
}

function notification_edition_form_validate($form, &$form_state) {
  notification_registration_form_validate($form, $form_state);
}

function notification_registration_form_submit($form, &$form_state) {

  _notification_register_event($form, $form_state, NO_COMMUNICATION_EVENT_ID);
  _notification_register_event($form, $form_state, CORRUPTED_MESSAGE_EVENT_ID);
  _notification_register_event($form, $form_state, COMMUNICATION_RESTORED_EVENT_ID);
  _notification_register_event($form, $form_state, PEAK_CONSUMPTION_EVENT_ID);

  $form_state['redirect'] = 'notification/list';
}

function notification_edition_form_submit($form, &$form_state) {

  _notification_edit_event($form, $form_state);

  $form_state['redirect'] = 'notification/list';
}

function notification_newsletter_form_submit($form, &$form_state) {

  $email     = $form_state['values']['email'];
  $firstname = $form_state['values']['firstname'];
  $surname   = $form_state['values']['surname'];

  $url = 'http://www.eor.de/fileadmin/verwaltung/mysmartgrid.php' .
    '?email='     . urlencode($email) .
    '&firstname=' . urlencode($firstname) .
    '&surname='   . urlencode($surname);
  //For testing, include '&test=1'

  $request = drupal_http_request($url);
  $response = $request->data;

  if ($response == "RECORD_CREATED") {

    drupal_set_message(t('Almost Finished... We need to confirm your email address. To complete the subscription process, please click the link in the email we just sent you.'));

  } else if ($response == "RECORD_UPDATED") {

    drupal_set_message(t('The e-mail address was already present in the database. The user data has been updated.'));

  } else {

    drupal_set_message(t('Our apologies. The newsletter subscription is temporarily unavailable. Please, try again later.'));

    _notification_send_system_error_email('newsletter', $response, $url);
  }
}

function _notification_register_event($form, $form_state, $event_id) {

  $selected = $form_state['values']["event_id$event_id"];

  if ($selected) {

    $device   = $form_state['values']['device'];
    $limit_up = $form_state['values']["limit_up$event_id"];
    $unit_id  = $form_state['values']["unit_id$event_id"];

    $emails       = $form_state['values']['emails'];
    $min_interval = $form_state['values']['min_interval'];

    _notification_delete($device, $event_id, $limit_up, $unit_id);
    _notification_insert($device, $event_id, $emails, $min_interval, $limit_up, $unit_id);
  }
}

function _notification_edit_event($form, $form_state) {

  $device       = $form_state['values']['device'];
  $event_id     = $form_state['values']["event_id"];
  $old_limit_up = $form_state['values']["old_limit_up"];
  $old_unit_id  = $form_state['values']["old_unit_id"];

  $limit_up     = $form_state['values']["limit_up"];
  $unit_id      = $form_state['values']["unit_id"];
  $emails       = $form_state['values']['emails'];
  $min_interval = $form_state['values']['min_interval'];

  _notification_delete($device, $event_id, $old_limit_up, $old_unit_id);
  _notification_delete($device, $event_id, $limit_up, $unit_id);
  _notification_insert($device, $event_id, $emails, $min_interval, $limit_up, $unit_id);
}

/**
 * Converts a string containing a list of emails into an array.
 *
 * @param $str  The string containing emails separated by space, new line char, or tab char.
 * @return an array of emails.
 */
function _notification_tokenize_emails($str) {

  $sep = " \n\r";
  $token = strtok($str, $sep);

  $tokens = array();
  while ($token !== FALSE) {
    $tokens[] = trim($token, $sep);
    $token = strtok($sep);
  }
  return $tokens;
}

/**
 * Returns an event name.
 *
 * @param $event_id  The event id.
 * @return the event name.
 */
function _notification_get_event_name($event_id) {

  $sql = "SELECT name FROM {event} WHERE id = %d";
  $name = db_result(db_query($sql, $event_id));
  return t($name);
}

/**
 * Returns an array of units associated with the informed event, indexed by their respective ids.
 * @param $event_id The event id.
 *
 * @return the array of units.
 */
function _notification_get_units_options($event_id) {

  $sql = "
    SELECT
      un.id,
      un.name
    FROM
      {unit} un,
      {event_unit} eu
    WHERE
      eu.event_id = %d AND
      eu.unit_id = un.id
    ORDER BY
      un.id";

  $result = db_query($sql, $event_id);

  $units = array();
  while ($row = db_fetch_array($result)) {
    $units[$row['id']] = t($row['name']);
  }
  return $units;
}

/**
 * Returns an array of notification frequencies indexed by their respective
 * time intervals in minutes.
 *
 * @return the array of frequencies.
 */
function _notification_get_frequency_options() {
  return array(
      0          => t('No limit, notify every single event'),
     30 * MINUTE => t('2 notifications per hour'),
      1 * HOUR   => t('1 notification per hour'),
     12 * HOUR   => t('2 notifications per day'),
      1 * DAY    => t('1 notification per day')
  );
}

/**
 * Deletes an event notification.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @param $limit_up  The event's threshold.
 * @param $unit_id   The unit id.
 */
function _notification_delete($device, $event_id, $limit_up, $unit_id) {

  $sql = "
    DELETE FROM
      {notification}
    WHERE
      device = '%s' AND
      event_id = %d AND
      limit_up = %d AND
      unit_id = %d";

  db_query($sql, $device, $event_id, $limit_up, $unit_id);
}

/**
 * Registers an event notification.
 *
 * @param $device        The monitored device.
 * @param $event_id      The event id.
 * @param $emails        The notification e-mail.
 * @param $min_interval  The minimum time interval between consecutive notifications of the same event.
 * @param $limit_up      The event's threshold.
 * @param $unit_id       The unit id.
 */
function _notification_insert($device, $event_id, $emails, $min_interval, $limit_up, $unit_id) {

  $sql = "
    INSERT INTO
      {notification} (device, event_id, emails, min_interval, base_time, limit_up, unit_id, last_sent)
    VALUES
      ('%s', %d, '%s', %d, %d, %d, %d, %d)";

  db_query($sql, $device, $event_id, $emails, $min_interval, time(), $limit_up, $unit_id, 0);
}

/**
 * Updates an event notification.
 * 
 * @param $device           The monitored device.
 * @param $event_id         The event id.
 * @param $limit_up         The event's threshold.
 * @param $time_field_name  The name of the timestamp field to be updated.
 * @param $time_field_value The new value of the timestamp field.
 */
function _notification_update($device, $event_id, $limit_up, $unit_id, $time_field_name, $time_field_value) {

  $sql = "
    UPDATE
      {notification}
    SET
      $time_field_name = %d
    WHERE
      device = '%s' AND
      event_id = %d AND
      limit_up = %d AND
      unit_id = %d";

  db_query($sql, $time_field_value, $device, $event_id, $limit_up, $unit_id);
}

function notification_cron() {

  $now = time();
  _notification_send_no_communication_emails($now);
  _notification_send_corrupted_message_emails($now);
  _notification_send_communication_restored_emails($now);
  _notification_send_peak_consumption_emails($now);

  _notification_eventlog_clear_old($now);
}

/**
 * Sends e-mails notifying users of "No Communication" events.
 *
 * @param $now The event checkup time.
 */
function _notification_send_no_communication_emails($now) {

  $sql = "
    SELECT DISTINCT
      n.event_id,
      n.device,
      n.serial,
      n.emails,
      FROM_UNIXTIME(%d + n.timezone, '%s') AS event_time,
      FROM_UNIXTIME(n.access + n.timezone, '%s') AS last_event_time,
      n.limit_up,
      n.unit_id,
      n.unit_name
    FROM
      (
        SELECT
          n.event_id,
          d.device,
          d.serial,
          n.emails,
          n.limit_up,
          n.last_sent,
          n.min_interval,
          n.unit_id,
          un.name AS unit_name,
          un.factor,
          IF(d.access > MAX(m.access), d.access, MAX(m.access)) AS access,
          u.timezone
        FROM
          {logger_meters} m,
          {logger_devices} d,
          {notification} n,
          {unit} un,
          {users} u
        WHERE
          m.device = d.device AND
          d.device = n.device AND
          n.event_id = %d AND
          n.unit_id = un.id AND
          d.uid = u.uid
        GROUP BY
          d.device,
          n.limit_up,
          n.unit_id
        HAVING
          SUM(m.corrupted) = 0
      ) n
    WHERE
      %d > (n.access + (n.limit_up * n.factor)) AND
      %d > (n.last_sent + n.limit_up) AND
      %d > (n.last_sent + n.min_interval)";

  $args = array($now,
    NOTIFICATION_TIMESTAMP_FORMAT_SQL, NOTIFICATION_TIMESTAMP_FORMAT_SQL,
    NO_COMMUNICATION_EVENT_ID, $now, $now, $now);

  $notifiables = _notification_query_notifiables($sql, $args);

  //ATTENTION: Any change in the following message requires its translations to be redefined.

  $message = _notification_compose_error_email(
    "Your Flukso device (serial number: %serial) has not been sending " .
    "data for more than %limit_up %unit_name, since %last_event_time.",

    "Check your WLAN configuration and make sure that it remains active for " .
    "at least 1 hour per day. The device might be working fine, but it is " .
    "failing to send the heartbeats over the internet.");

  _notification_send_emails($message, $notifiables);
}

/**
 * Sends e-mails notifying users of "Communication Restored" events.
 *
 * @param $now The event checkup time.
 */
function _notification_send_communication_restored_emails($now) {

  $sql = "
    SELECT DISTINCT
      n.event_id,
      n.device,
      d.serial,
      n.emails,
      FROM_UNIXTIME(%d + u.timezone, '%s') AS event_time,
      FROM_UNIXTIME(e.latest_time - (n.limit_up * un.factor) + u.timezone, '%s') AS last_event_time,
      n.limit_up,
      n.unit_id,
      un.name AS unit_name
    FROM
      {users} u,
      {unit} un,
      {logger_devices} d,
      {notification} n JOIN
      (
        SELECT
          device,
          MAX(time) AS latest_time
        FROM
          {event_log}
        WHERE
          event_id IN (%d, %d)
        GROUP BY
          device
      ) e ON n.device = e.device
    WHERE
      d.device = n.device AND
      n.event_id = %d AND
      n.unit_id = un.id AND
      d.uid = u.uid AND
      %d > (n.last_sent + n.limit_up) AND
      %d > (n.last_sent + n.min_interval) AND
      EXISTS (
        SELECT
          1
        FROM
          {event_log} p
        WHERE
          p.device = e.device AND
          p.event_id IN (%d, %d) AND
          (p.time + (n.limit_up * un.factor)) < e.latest_time  AND
          (p.time > n.last_sent OR n.last_sent = 0)
      )";

  $args = array($now,
    NOTIFICATION_TIMESTAMP_FORMAT_SQL, NOTIFICATION_TIMESTAMP_FORMAT_SQL,
    HEARTBEAT_RECEIVED_EVENT_ID, MEASUREMENT_RECEIVED_EVENT_ID,
    COMMUNICATION_RESTORED_EVENT_ID, $now, $now,
    HEARTBEAT_RECEIVED_EVENT_ID, MEASUREMENT_RECEIVED_EVENT_ID);

  $notifiables = _notification_query_notifiables($sql, $args);

  //ATTENTION: Any change in the following message requires its translations to be redefined.

  $message = _notification_compose_error_email(
    "Your Flukso device (serial number: %serial) has restored its " .
    "communication with the server at %event_time. " .
    "It had not been sending data for more than %limit_up %unit_name, " .
    "since %last_event_time.",

    "Check your WLAN configuration and make sure that it remains active for " .
    "at least 1 hour per day. The device might be working fine, but it is " .
    "failing to send the heartbeats over the internet.");

  _notification_send_emails($message, $notifiables);
}

/**
 * Sends e-mails notifying users of "Corrupted Message" events.
 *
 * @param $now The event checkup time.
 */
function _notification_send_corrupted_message_emails($now) {

  $sql = "
    SELECT DISTINCT
      n.event_id,
      d.device,
      d.serial,
      n.emails,
      FROM_UNIXTIME(m.corrupted + u.timezone, '%s') AS event_time,
      n.limit_up,
      n.unit_id
    FROM
      {users} u,
      {logger_devices} d,
      {logger_meters} m,
      {notification} n
    WHERE
      d.uid = u.uid AND
      d.device = n.device AND
      n.event_id = %d AND
      %d > (n.last_sent + n.min_interval) AND
      m.device = d.device AND
      m.corrupted <> 0";

  $args = array(NOTIFICATION_TIMESTAMP_FORMAT_SQL, CORRUPTED_MESSAGE_EVENT_ID, $now);

  $notifiables = _notification_query_notifiables($sql, $args);

  //ATTENTION: Any change in the following message requires its translations to be redefined.
  $message = _notification_compose_error_email(
    "Your Flukso device (serial number: %serial) has sent either a measurement or a heartbeat with " .
    "corrupted data at %event_time.");

  _notification_send_emails($message, $notifiables);
}

/**
 * Sends em-mails notifying users of the occurrence of Peak Consumption events.
 *
 * @param $now The event checkup time.
 */
function _notification_send_peak_consumption_emails($now) {

  $sql = "
    SELECT DISTINCT
      n.event_id,
      d.device,
      d.serial,
      n.emails,
      n.base_time AS start_time,
      n.limit_up,
      un.id AS unit_id,
      un.name AS unit_name,
      u.timezone
    FROM
      {users} u,
      {logger_devices} d,
      {logger_meters} m,
      {notification} n,
      {unit} un
    WHERE
      d.uid = u.uid AND
      d.device = n.device AND
      n.event_id = %d AND
      n.unit_id = un.id AND
      %d > (n.last_sent + n.min_interval) AND
      m.device = d.device AND
      m.type = %d";

  $args = array(PEAK_CONSUMPTION_EVENT_ID, $now, CONSUMPTION_SENSOR_TYPE);

  $notifiables = array();
  foreach (_notification_query_notifiables($sql, $args) as $notifiable) {

    $violations = _notification_query_peak_consumption_violations($notifiable);
    if ($violations) {

      $notifiable['violations'] = $violations['list'];
      $base_time = $violations['timestamp'] - $notifiable['timezone'];
      $notifiables[] = $notifiable;

      _notification_update($notifiable['device'], $notifiable['event_id'], $notifiable['limit_up'], $notifiable['unit_id'], 'base_time', $base_time);
    }
  }

  //ATTENTION: Any change in the following message requires its translations to be redefined.
  $message = _notification_compose_email(
    "Your Flukso device (serial number: %serial) has registered peaks of " .
    "power consumption above the limit of %limit_up %unit_name.<br><br> " .

    "The following list shows the measurements above the limit.<br><br> " .
    "!violations <br><br>");

  _notification_send_emails($message, $notifiables);
}

/**
 * Queries notifiable users.
 * 
 * @param $sql   The SQL statement to execute.
 * @param $args  The query arguments.
 * @return the array of notifiable users.
 */
function _notification_query_notifiables($sql, $args) {

  $notifiables = array();
  $result = db_query($sql, $args);

  while ($notifiable = db_fetch_array($result)) {
    $notifiable['unit_name'] = t($notifiable['unit_name']);
    $notifiables[] = $notifiable;
  }
  return $notifiables;
}

/**
 * Notifies the administrator of the occurrence of a system error.
 *
 * @param $context     The page or function where the error occurred.
 * @param $error_code  The error code.
 * @param $url         The URL that triggered the error (if any).
 */
function _notification_send_system_error_email($context, $error_code, $url) {

  //ATTENTION: Any change in the following message requires its translations to be redefined.

  $error_descriptions['newsletter']['ERROR_INVALID_DATA'] =
    'Invalid e-mail address.';

  $error_descriptions['newsletter']['ERROR_INSERT_FAILED'] =
    'Error while inserting the record in mySQL database.';

  $error_descriptions['newsletter']['ERROR_UPDATE_FAILED'] =
    'Error while updating the record in mySQL database.';

  $message =
    "<p>Dear Administrator " .
    "<br> &nbsp;<br></p> " .

    "<p>The following system error has been reported.</p> " .
    "<p>Error code: %error_code<br> " .
    "Description: %description<br> " .
    "Related URL: %url</p> " .

    "<p>&nbsp;<br> " .
    "<p>mySmartGrid System</p>";

  $variables['%error_code'] = $error_code;
  $variables['%description'] = t($error_descriptions[$context][$error_code]);
  $variables['%url'] = $url;

  $body = t($message, $variables);
  $subject = t('System Error');
  $email = 'notifications@mysmartgrid.de';

  _notification_send_email($email, $subject, $body);
}

/**
 * Composes an e-mail that notifies a general event.
 *
 * @param $description  The event description.
 * @param $complement   Complementary information about the error.
 * @return the e-mail message.
 */
function _notification_compose_email($description, $complement = NULL) {

  //ATTENTION: Any change in the following message requires its translations to be redefined.

  $complement = $complement == NULL? "" : "<p>$complement</p> ";

  return
    "<p>Dear user " .
    "<br> &nbsp;<br></p> " .

    "<p>$description</p> " .

    $complement .

    "<p>If you want to stop receiving this notification, please remove it from your " .
    "<a href='!base_url/notification/list'>event notifications list</a>.</p> " .

    "<p>&nbsp;<br> " .
    "Best Regards,</p> " .
    "<p>mySmartGrid Team</p>";
}

/**
 * Composes an e-mail that notifies an error event.
 *
 * @param $description    The error description.
 * @param $recommendation The recommendation for the user of how to solve the problem.
 * @return the e-mail message.
 */
function _notification_compose_error_email($description, $recommendation = NULL) {

  $recommendation = $recommendation == NULL? "": "<li>$recommendation<br><br>";

  //ATTENTION: Any change in the following message requires its translations to be redefined.
  return _notification_compose_email($description,

    "In order to identify and solve the problem, please take the following actions. " .
    "<ul> " .
      $recommendation .
      "<li>Click " .
      "<a href='!base_url/event/log/list/!serial '>here</a> " .
      "to check the latest events of your Flukso device.<br><br> " .

      "<li>Check if the device complies with the " .
      "<a href='!base_url/content/installationsanleitung-des-fluksos'>Flukso installation instructions</a>. " .
      "It might be improperly installed or misconfigured.<br><br> " .

      "<li>Visit our <a href='!base_url/content/h&#228;ufige-fragen-und-antworten'>FAQ</a>, " .
      "and read the answers to questions made by other users in similar situations.<br><br> " .

      "<li>In case the problem persists, please send an e-mail to msg-support@itwm.fhg.de. " .
    "</ul>");
}

/**
 * Sends event notification e-mails to notifiable users.
 *
 * @param $message      The e-mail message.
 * @param $notifiables  The array of notifiable users.
 */
function _notification_send_emails($message, $notifiables) {

  global $base_url;
  $variables = array();
  $variables["!base_url"] = $base_url;

  foreach ($notifiables as $notifiable) {
    foreach ($notifiable as $key => $value) {

      $variables["%$key"] = $value;
      $variables["!$key"] = $value;
    }

    $subject = t('Event Notification');

    $logo = "<p><img src='$base_url/sites/all/themes/mysmartgrid/logo.png'/></p>";
    $body = t($message, $variables) . $logo;

    $emails = $notifiable['emails'];
    foreach (_notification_tokenize_emails($emails) as $email) {
      _notification_send_email($email, $subject, $body);
    }

    _notification_update($notifiable['device'], $notifiable['event_id'], $notifiable['limit_up'], $notifiable['unit_id'], 'last_sent', time());
  }
}

/**
 * Returns a list of measurements that violate the Peak Consumption limit.
 *
 * @param $notifiable  The user notifiable of the Peak Consumption Event.
 * @return an array containing the latest timestamp and the HTML list of measurements.
 */
function _notification_query_peak_consumption_violations($notifiable) {

  $list = NULL;
  $measurements = logger_query_device_measurements('hour', $notifiable['device'], $notifiable['timezone']);

  foreach ($measurements as $meter => $data) {
    foreach ($data as $function => $values) {
      $sublist = NULL;

      foreach ($values as $timestamp => $value) {

        if ($value > $notifiable['limit_up'] && $timestamp > $notifiable['start_time'] + $notifiable['timezone']) {

          $sublist = $sublist? $sublist : t('Sensor') . ': ' . $function . '<br> ';
          $sublist .= date(NOTIFICATION_TIMESTAMP_FORMAT_PHP, $timestamp) . ' - ' .
            number_format($value, 2, '.', '') . ' ' . t('watt') . '<br> ';
        }
      }
      $list .= $sublist;
    }
  }
  return $list ? array('timestamp' => $timestamp, 'list' => $list) : NULL;
}

/**
 * Sends a notification e-mail.
 *
 * @param $email    The e-mail address.
 * @param $subject  The e-mail subject.
 * @param $body     The e-mail body.
 */
function _notification_send_email($email, $subject, $body) {

  global $language;
  drupal_mail('notification', 'notice', $email, $language, array('subject' => $subject, 'body' => $body));
}

function notification_mail($key, &$message, $params) {

  $message['headers']['Content-Type'] = "text/html; charset=UTF-8";
  $message['subject'] = $params['subject'];
  $message['body'][] = $params['body'];
}