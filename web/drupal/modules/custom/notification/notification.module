<?php

/**
 * This module manages Flukso devices' event notifications.
 *
 * Copyright (c) 2010 Fraunhofer Institut ITWM (www.itwm.fraunhofer.de)
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */

function notification_help($path, $arg) {
  
  $output = '';

  switch ($path) {
    case "admin/help#notification":
      $output = '<p>'.t("Allows the users to manage device event notifications.").'</p>';
      break;
  }

  return $output;
}

function notification_perm() {
  return array('manage notifications');
}

function notification_settings_access($permission, $account) {
  return ($account->uid == $GLOBALS['user']->uid && user_access($permission));
}

function notification_menu() {

  $items = array();

  $items['notification/list'] = array(
    'title'             => 'Event Notifications',
    'page callback'     => 'notification_list_page',
    'access arguments'  => array('manage notifications'),
    'type'              => MENU_NORMAL_ITEM
  );

  $items['notification/delete'] = array(
    'title'             => $items['notification/list']['title'],
    'page callback'     => 'notification_delete',
    'page arguments'    => array(2, 3),
    'access arguments'  => array('manage notifications'),
    'type'              => MENU_CALLBACK
  );

  $items['notification/register'] = array(
    'title'             => 'Event Notification Registration',
    'page callback'     => 'notification_registration_page',
    'access arguments'  => array('manage notifications'),
    'type'              => MENU_CALLBACK
  );

  $items['notification/edit'] = array(
    'title'             => 'Event Notification Edition',
    'page callback'     => 'notification_edition_page',
    'page arguments'    => array(2, 3),
    'access arguments'  => array('manage notifications'),
    'type'              => MENU_CALLBACK
  );

  return $items;
}

/**
 * Event notification deletion callback.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @return the events list page.
 */
function notification_delete($device, $event_id) {

  _notification_delete($device, $event_id);
  return notification_list_page();
}

/**
 * Builds the event registration page.
 *
 * @return the event registration page.
 */
function notification_registration_page() {
  $output .= drupal_get_form('notification_registration_form');
  return $output;
}

/**
 * Builds the event notification edition page.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @return the event notification edition page.
 */
function notification_edition_page($device, $event_id) {

  $sql = "
    SELECT
      e.id AS event_id,
      e.name AS event_name,
      n.device AS device,
      d.serial AS serial,
      n.email AS email,
      n.limit_up AS limit_up
    FROM
      {event} e,
      {notification} n,
      {logger_devices} d
    WHERE
      d.device = '%s' AND
      d.device = n.device AND
      n.event_id = e.id AND
      e.id = %d";

  $notification = db_fetch_object(db_query($sql, $device, $event_id));

  $output .= drupal_get_form('notification_edition_form', $notification);

  return $output;
}

/**
 * Builds the events list page.
 *
 * @return the events list page.
 */
function notification_list_page() {

  $sql = "
    SELECT
      d.serial AS serial,
      e.name AS event_name,
      n.email AS email,
      n.limit_up AS limit_up,
      d.device AS device,
      e.id AS event_id
    FROM
      {logger_devices} d,
      {notification} n,
      {event} e
    WHERE
      d.uid = %d AND
      d.device = n.device AND
      n.event_id = e.id";

  $header = array(
    array('data' => t('Device'),        'field' => 'serial',     'sort' => 'ASC'),
    array('data' => t('Event'),         'field' => 'event_name', 'sort' => 'ASC'),
    array('data' => t('Target e-mail'), 'field' => 'email'),
    array('data' => t('Operation'))
  );

  global $user;
  $result = db_query($sql, $user->uid, tablesort_sql($header));

  $rows = array();
  while ($object = db_fetch_array($result)) {

    $row = array();
    $row['serial'] = $object['serial'];
    $row['event_name'] = _notification_format_event_name($object['event_id'], $object['event_name'], $object['limit_up']);
    $row['email'] = $object['email'];
    $row[] = l(t('Remove'), 'notification/delete/' . $object['device'] . '/' . $object['event_id']) . '<br>' .
             l(t('Edit'),   'notification/edit/'   . $object['device'] . '/' . $object['event_id']);

    $rows[] = $row;
  }

  $caption = '<p>' . l(t('Register Notification'), 'notification/register') . '</p>';

  $output .= theme('table', $header, $rows, array(), $caption);
  return $output;
}

function notification_registration_form() {

  global $user;

  $form['email'] = array(
    '#type'           => 'textfield',
    '#title'          => t('E-mail'),
    '#description'    => t('Enter the e-mail which will receive the event notification.'),
    '#maxlength'      => 64,
    '#size'           => 20,
    '#default_value'  => $user->mail,
    '#element_validate'  => array('notification_email_validate'),
  );

  $form['device'] = array(
    '#type'           => 'select',
    '#title'          => t('Serial Number'),
    '#description'    => t('Select the serial number of the monitored device.'),
    '#options'        => _notification_get_devices_options()
  );

  $form['events'] = array(
    '#type'           => 'fieldset',
    '#title'          => t('Events'),
    '#prefix'         => '<br>'
  );

  $form['events']['event_id1'] = array(
    '#title'          => _notification_get_event_name(1),
    '#type'           => 'checkbox',
    '#default_value'  => FALSE,
    '#prefix'         => '<br><table width="100%"><tr><td>',
    '#suffix'         => '</td>',
    '#attributes'     => array(
      'onchange' => '
        limit_up1 = document.getElementById("limit_up1");
        limit_up1.readOnly = !this.checked;
        limit_up1.value = this.checked ? 120 : "";'
    ),
  );

  $form['events']['limit_up1'] = array(
    '#type'           => 'textfield',
    '#description'    => t('Here you can set the maximum heartbeat delay. Beyond this limit, the device is considered faulty.'),
    '#maxlength'      => 9,
    '#size'           => 12,
    '#field_suffix'   => t('minutes'),
    '#prefix'         => '<td>',
    '#suffix'         => '</td></tr>',
    '#attributes'     => array(
      'onchange' => '
        event_id1 = document.getElementById("event_id1");
        limit_up1.readOnly = !event_id1.checked;'
    ),
  );

  $form['events']['event_id3'] = array(
    '#title'          => _notification_get_event_name(3),
    '#type'           => 'checkbox',
    '#default_value'  => FALSE,
    '#prefix'         => '<tr><td>',
    '#suffix'         => '</td>',
    '#attributes'     => array(
      'onchange' => '
        limit_up3 = document.getElementById("limit_up3");
        limit_up3.readOnly = !this.checked;
        limit_up3.value = this.checked ? 120 : "";'
    ),
  );

  $form['events']['limit_up3'] = array(
    '#type'           => 'textfield',
    '#description'    => $form['events']['limit_up1']['#description'],
    '#maxlength'      => 9,
    '#size'           => 12,
    '#field_suffix'   => t('minutes'),
    '#prefix'         => '<td>',
    '#suffix'         => '</td></tr>',
    '#attributes'     => array(
      'onchange' => '
        event_id3 = document.getElementById("event_id3");
        limit_up3.readOnly = !event_id3.checked;'
    ),
  );

  $form['events']['event_id4'] = array(
    '#title'          => _notification_get_event_name(4),
    '#type'           => 'checkbox',
    '#default_value'  => FALSE,
    '#prefix'         => '<tr><td>',
    '#suffix'         => '</td>',
    '#attributes'     => array(
      'onchange' => '
        limit_up4 = document.getElementById("limit_up4");
        limit_up4.readOnly = !this.checked;
        limit_up4.value = this.checked ? 5000 : "";'
    ),
  );

  $form['events']['limit_up4'] = array(
    '#type'           => 'textfield',
    '#description'    => t('Here you can set the maximum electricity consumption. Beyond this limit, the device is considered faulty.'),
    '#maxlength'      => 12,
    '#size'           => 12,
    '#field_suffix'   => t('watt / h'),
    '#prefix'         => '<td>',
    '#suffix'         => '</td></tr>',
    '#attributes'     => array(
      'onchange' => '
        event_id4 = document.getElementById("event_id4");
        limit_up4.readOnly = !event_id4.checked;' 
    ),
  );

  $form['events']['event_id2'] = array(
    '#title'          => _notification_get_event_name(2),
    '#type'           => 'checkbox',
    '#default_value'  => FALSE,
    '#prefix'         => '<tr><td>',
    '#suffix'         => '</td><td></td></tr></table>'
  );

  $form['submit'] = array(
    '#type'   => 'submit',
    '#value'  => t('Save')
  );

  return $form;
}

function notification_edition_form(&$form_state, $notification) {

  $form['device'] = array(
    '#type'              => 'hidden',
    '#default_value'     => $notification->device,
  );

  $form['event_id'] = array(
    '#type'              => 'hidden',
    '#default_value'     => $notification->event_id,
  );

  $form['event_name'] = array(
    '#type'              => 'textfield',
    '#title'             => t('Event'),
    '#default_value'     => $notification->event_name,
    '#attributes'        => array('readOnly' => 'true')
  );

  $form['serial'] = array(
    '#type'              => 'textfield',
    '#title'             => t('Serial Number'),
    '#default_value'     => $notification->serial,
    '#attributes'        => array('readOnly' => 'true')
  );

  $form['email'] = array(
    '#type'              => 'textfield',
    '#title'             => t('E-mail'),
    '#description'       => t('Enter the e-mail which will receive the event notification.'),
    '#maxlength'         => 64,
    '#size'              => 20,
    '#default_value'     => $notification->email,
    '#element_validate'  => array('notification_email_validate'),
  );

  switch ($notification->event_id) {
    case 1:
    case 3:
      $form['limit_up'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Maximum Delay'),
        '#description'   => t('Here you can set the maximum heartbeat delay. Beyond this limit, the device is considered faulty.'),
        '#maxlength'     => 9,
        '#size'          => 12,
        '#field_suffix'  => t('minutes'),
        '#default_value' => $notification->limit_up
      );
      break;

    case 4:
      $form['limit_up'] = array(
        '#type'          => 'textfield',
        '#title'         => t('Maximum Consumption'),
        '#description'   => t('Here you can set the maximum electricity consumption. Beyond this limit, the device is considered faulty.'),
        '#maxlength'     => 9,
        '#size'          => 12,
        '#field_suffix'  => t('watt / h'),
        '#default_value' => $notification->limit_up
      );
      break;
    case 2:
      break;
  } 

  $form['submit'] = array(
    '#type'  => 'submit',
    '#value' => t('Save')
  );

  return $form;
}

function notification_registration_form_validate($form, &$form_state) {

  $event_id1 = $form_state['values']['event_id1'];
  $event_id3 = $form_state['values']['event_id3'];
  $event_id4 = $form_state['values']['event_id4'];

  if($event_id1) {
    _notification_validate_minutes('limit_up1', $form_state);
  }

  if($event_id3) {
    _notification_validate_minutes('limit_up3', $form_state);
  }
  
  if ($event_id4) {
    _notification_validate_watts('limit_up4', $form_state);
  }
}

function notification_edition_form_validate($form, &$form_state) {

  $event_id = $form_state['values']['event_id'];

  switch ($event_id) {
    case 1 :
    case 3 :
      _notification_validate_minutes('limit_up', $form_state);
      break;

    case 4 :
      _notification_validate_watts('limit_up', $form_state);
      break;
  }
}

function notification_email_validate($element, $form_state) {

  if (!valid_email_address($form_state['values']['email'])) {
    form_error($element, t('Invalid e-mail.'));
  }
}

/**
 * Validates a field to enter minutes.
 *
 * @param $field  The field name.
 */
function _notification_validate_minutes($field, $form_state) {

  $limit_up = $form_state['values'][$field];

  if($limit_up < 30) {
    form_set_error($field, t('Delay time can not be less than 30 minutes.'));
  }
}

/**
 * Validates a field to enter watts.
 *
 * @param $field  The field name.
 */
function _notification_validate_watts($field, $form_state) {

  $limit_up = $form_state['values'][$field];
  
  if($limit_up < 1) {
    form_set_error($field, t('Peak consumption can not be less than 1 watt.'));
  }
}

function notification_registration_form_submit($form, &$form_state) {

  $device    = $form_state['values']['device'];
  $email     = $form_state['values']['email'];

  $event_id1 = $form_state['values']['event_id1'];
  $limit_up1 = $form_state['values']['limit_up1'];

  $event_id2 = $form_state['values']['event_id2'];

  $event_id3 = $form_state['values']['event_id3'];
  $limit_up3 = $form_state['values']['limit_up3'];

  $event_id4 = $form_state['values']['event_id4'];
  $limit_up4 = $form_state['values']['limit_up4'];

  if ($event_id1) {
    _notification_delete($device, 1);
    _notification_insert($device, 1, $email, $limit_up1);
  }

  if ($event_id2) {
    _notification_delete($device, 2);
    _notification_insert($device, 2, $email, 0);
  }

  if ($event_id3) {
    _notification_delete($device, 3);
    _notification_insert($device, 3, $email, $limit_up3);
  }

  if ($event_id4) {
    _notification_delete($device, 4);
    _notification_insert($device, 4, $email, $limit_up4);
  }

  $form_state['redirect'] = 'notification/list';
}

function notification_edition_form_submit($form, &$form_state) {

  $device   = $form_state['values']['device'];
  $email    = $form_state['values']['email'];
  $event_id = $form_state['values']['event_id'];
  $limit_up = $event_id == 2? 0 : $form_state['values']['limit_up'];

  _notification_delete($device, $event_id);
  _notification_insert($device, $event_id, $email, $limit_up);

  $form_state['redirect'] = 'notification/list';
}

/**
 * Returns an event name.
 *
 * @param $event_id  The event id.
 * @return the event name.
 */
function _notification_get_event_name($event_id) {

  $sql = "SELECT name FROM {event} WHERE id = %d";
  $result = db_fetch_object(db_query($sql, $event_id));

  return t($result->name);
}

/**
 * Formats an event name to be shown in a web page.
 *
 * @param $event_id   The event id.
 * @param $event_name The event name.
 * @param $limit_up   The event related maximum value.
 * @return the event formatted name.
 */
function _notification_format_event_name($event_id, $event_name, $limit_up) {

  $name = t($event_name);

  if ($event_id == 1 || $event_id == 3) {
    $name .= "<br>(in $limit_up min)";

  } else if ($event_id == 4) {
    $name .= "<br>($limit_up watt / h)";
  }
  return $name;
}

/**
 * Returns an array of user devices' serial numbers indexed by their respective
 * hash codes.
 *
 * @return the array of devices.
 */
function _notification_get_devices_options() {

  global $user;
  $sql = "SELECT serial, device FROM {logger_devices} WHERE uid = %d ORDER BY serial";
  $result = db_query($sql, $user->uid);

  $devices = array();
  while ($row = db_fetch_array($result)) {
    $devices[$row['device']] = $row['serial'];
  }

  return $devices;
}

/**
 * Deletes an event notification.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 */
function _notification_delete($device, $event_id) {

  $sql = "
    DELETE FROM
      {notification}
    WHERE
      device = '%s' AND
      event_id = %d";

  db_query($sql, $device, $event_id);
}

/**
 * Registers an event notification.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @param $email     The notification e-mail.
 * @param $limit_up  An event related maximum value.
 */
function _notification_insert($device, $event_id, $email, $limit_up) {

  global $user;
  $base_value = 0;

  //If event = Peak Consumption
  if ($event_id == 4) {

    $sql = "
      SELECT
        SUM(m.value) AS total
      FROM
        {logger_meters} m
      WHERE
        m.type = '%s' AND
        m.unit = '%s' AND
        m.uid = %d";

    $result = db_fetch_object( db_query($sql, 'electricity', 'watt', $user->uid));

    $base_value = $result->total;
  }

  $sql = "
    INSERT INTO
      {notification} (device, event_id, email, base_value, latest_checkup, limit_up, last_sent)
    VALUES
      ('%s', %d, '%s', %d, %d, %d, %d)";

  db_query($sql, $device, $event_id, $email, $base_value, time(), $limit_up, 0);
}

/**
 * Updates an event notification.
 *
 * @param $device    The monitored device.
 * @param $event_id  The event id.
 * @param $last_sent The timestamp when the latest email was sent.
 */
function _notification_update($device, $event_id, $last_sent) {

  $sql = "
    UPDATE
      {notification}
    SET
      last_sent = %d
    WHERE
      device = '%s' AND
      event_id = %d";

  db_query($sql, $last_sent, $device, $event_id);
}

/**
 * Updates notification checkup date.
 */
function _notification_update_checkups() {

  $sql = "UPDATE {notification} SET latest_checkup = %d";

  db_query($sql, time());
}

function notification_cron() {

  _notification_send_no_heartbeat_emails();
  _notification_send_corrupted_heartbeat_emails();
  _notification_send_any_heartbeat_failure_emails();
  _notification_send_peak_consumption_emails();

  _notification_update_checkups();
}

/**
 * Sends e-mails notifying users of "No Heartbeat" events.
 * 
 * @param $event_id  The actual event that is causing the notification to be sent.
 *                   It can be either "No Heartbeat" or "Any Heartbeat Failure".
 */
function _notification_send_no_heartbeat_emails($event_id = 1) {

  $tz = _notification_get_user_timezone();

  $sql = "
    SELECT
      d.device AS device,
      n.event_id AS event_id,
      u.name AS user_name,
      n.email AS email,
      d.serial AS serial,
      CONVERT_TZ(FROM_UNIXTIME(d.access),'+00:00',$tz) AS event_time,
      n.limit_up AS limit_up
    FROM
      {users} u,
      {logger_devices} d,
      {notification} n
    WHERE
      u.uid = d.uid AND
      d.device = n.device AND
      SYSDATE() > (FROM_UNIXTIME(d.access) + INTERVAL n.limit_up MINUTE) AND
      SYSDATE() > (FROM_UNIXTIME(n.last_sent) + INTERVAL 1 DAY) AND
      n.event_id = $event_id";

  $message = _notification_compose_error_email("
    Your Flukso device (serial number: %serial) has not been sending heartbeats for more
    than %limit_up minutes, since %event_time.",

    "Check your WLAN configuration and make sure that it remains active for at least 1 hour per day.
    The device might be working fine, but it is failing to send the heartbeats over the internet.");

  _notification_send_emails($sql, $message);
}

/**
 * Sends e-mails notifying users of "Corrupted Heartbeat" events.
 *
 * @param $event_id  The actual event that is causing the notification to be sent.
 *                   It can be either "Corrupted Heartbeat" or "Any Heartbeat Failure".
 */
function _notification_send_corrupted_heartbeat_emails($event_id = 2) {

  $tz = _notification_get_user_timezone();

  $sql = "
    SELECT
      d.device AS device,
      n.event_id AS event_id,
      u.name AS user_name,
      n.email AS email,
      d.serial AS serial,
      CONVERT_TZ(FROM_UNIXTIME(d.access),'+00:00',$tz) AS event_time
    FROM
      {users} u,
      {logger_devices} d,
      {logger_meters} m,
      {notification} n
    WHERE
      u.uid = d.uid AND
      d.device = m.device AND
      m.type = 'electricity' AND
      SYSDATE() > (FROM_UNIXTIME(m.access) + INTERVAL 2 HOUR) AND
      SYSDATE() > (FROM_UNIXTIME(n.last_sent) + INTERVAL 1 DAY) AND
      d.device = n.device AND
      n.event_id = $event_id";

  $message = _notification_compose_error_email("
    Your Flukso device (serial number: %serial) has sent a heartbeat with corrupted data at %event_time.");

  _notification_send_emails($sql, $message);
}

/**
 * Sends e-mails notifying users of "Any Heartbeat Failure" events.
 */
function _notification_send_any_heartbeat_failure_emails() {

  _notification_send_no_heartbeat_emails(3);
  _notification_send_corrupted_heartbeat_emails(3);
}

/**
 * Sends em-mails notifying users of the occurrence of Peak Consumption events.
 */
function _notification_send_peak_consumption_emails() {

  $tz = _notification_get_user_timezone();

  $sql = "
    SELECT
      d.device AS device,
      n.event_id AS event_id,
      u.name AS user_name,
      n.email AS email,
      d.serial AS serial,
      CONVERT_TZ(FROM_UNIXTIME(d.access),'+00:00',$tz) AS event_time,
      n.limit_up AS limit_up,
      n.base_value AS base_value,
      n.latest_checkup AS latest_checkup
    FROM
      {users} u,
      {logger_devices} d,
      {logger_meters} m,
      {notification} n
    WHERE
      u.uid = d.uid AND
      d.device = n.device AND
      n.event_id = 4 AND
      d.device = m.device AND
      m.type = 'electricity' AND
      m.unit = 'watt' AND
      SYSDATE() > (FROM_UNIXTIME(n.last_sent) + INTERVAL 1 DAY)
    GROUP BY
      u.name,
      n.email,
      d.access,
      n.limit_up,
      n.base_value
    HAVING
      (SUM(m.value) - n.base_value) / ((UNIX_TIMESTAMP(SYSDATE()) - n.latest_checkup) / 3600) > n.limit_up";

  $message = _notification_compose_email("
    Your Flukso device (serial number: %serial) has registered an electricity consumption
    beyond %limit_up watts, at %event_time.");

  _notification_send_emails($sql, $message);

  //Register consumption
  $sql = "
    UPDATE
      {notification}
    SET
      base_value =
        SELECT
          SUM(m.value)
        FROM
          {logger_meters} m
        WHERE
          m.type = '%s' AND
          m.unit = '%s' AND
          m.device = notification.device
    WHERE
      notification.event_id = 4";

  db_query($sql, 'electricity', 'watt');
}

function _notification_register_consumption() {

  $sql = "
    UPDATE
      {notification}
    SET
      base_value =
        SELECT
          SUM(m.value)
        FROM
          {logger_meters} m
        WHERE
          m.type = '%s' AND
          m.unit = '%s' AND
          m.device = notification.device
    WHERE
      notification.event_id = 4";

  db_query($sql, 'electricity', 'watt');


  $now = time();

  $sql = "
    UPDATE
      {notification}
    SET
      latest_checkup = $now";

  db_query($sql, 'electricity', 'watt');
}

/**
 * Composes an e-mail that notifies a general event.
 *
 * @param $description  The event description.
 * @param $complement   Complementary information about the error.
 * @return the e-mail message.
 */
function _notification_compose_email($description, $complement = "") {

  global $base_url;

  return "
    <p>Dear user %user_name
    <br> &nbsp;<br></p>

    <p>$description</p>
    <p>$complement</p>

    <p>If you want to stop receiving this notification, please remove it from your
    <a href='$base_url/notification/list'>event notifications list</a>.</p>

    <p>&nbsp;<br>
    Best Regards,</p>
    <p>mySmartGrid Team</p>";
}

/**
 * Composes an e-mail that notifies an error event.
 *
 * @param $description    The error description.
 * @param $recommendation The recommendation for the user of how to solve the problem.
 * @return the e-mail message.
 */
function _notification_compose_error_email($description, $recommendation = NULL) {

  $recommendation = $recommendation == NULL? "": "<li>$recommendation<br><br>";

  global $base_url;

  return _notification_compose_email($description, "

    In order to identify and solve the problem, please take the following actions.
    <ul>
      $recommendation

      <li>Check if the device complies with the
      <a href='$base_url/content/installationsanleitung-des-fluksos'>Flukso installation instructions</a>.
      It might be improperly installed or misconfigured.<br><br>

      <li>Visit our <a href='$base_url/content/h&#228;ufige-fragen-und-antworten'>FAQ</a>, and
      read the answers to questions made by other users in similar situations.<br><br>

      <li>In case the problem persists, please send an e-mail to msg-support@itwm.fhg.de.
    </ul>");
}

/**
 * Sends event notification e-mails to notifiable users.
 *
 * @param $sql     The SQL statement for selecting the events.
 * @param $message The e-mail message.
 */
function _notification_send_emails($sql, $message) {

  global $user;
  global $base_url;
  $language = user_preferred_language($user);
  $result = db_query($sql);
  $logo = "<p><img src='$base_url/sites/all/themes/mysmartgrid/logo.png'/></p>";

  while ($object = db_fetch_array($result)) {

    $variables = array();
    foreach ($object as $key => $value) {
      $variables["%$key"] = $value;
    }

    $subject = t('Event Notification');
    $body = t($message, $variables, $language->language) . $logo;

    $params = array(
      'subject' => $subject,
      'body' => $body
    );

    _notification_update($object['device'], $object['event_id'], time());

    drupal_mail('notification', 'notice', $object['email'], $language, $params);
  }
}

function notification_mail($key, &$message, $params) {

  $message['headers']['Content-Type'] = "text/html; charset=UTF-8";
  $message['subject'] = $params['subject'];
  $message['body'][] = $params['body'];
}

/**
 * Returns the user formatted timezone.
 * 
 * @return the formatted timezone.
 */
function _notification_get_user_timezone() {
  global $user;
  $hours = $user->timezone / (60 * 60);
  return $hours < 0 ? "'$hours:00'" : "'+$hours:00'";
}